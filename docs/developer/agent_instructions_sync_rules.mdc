---
alwaysApply: true
---

# Agent Instructions Sync Rule

## Purpose

Ensures behavioral instructions stay in sync across the two agent instruction files. When either file is updated, the equivalent change must be applied to the other.

## Scope

The two files governed by this rule:

- `docs/developer/mcp/instructions.md` — loaded at runtime by `getMcpInteractionInstructions()` in `src/server.ts`; sent verbatim to MCP clients
- `docs/developer/cli_agent_instructions.md` — source of truth for CLI agent rules; applied to `.cursor/rules/neotoma_cli.mdc`, `.claude/rules/`, and `.codex/` by `neotoma cli-instructions check`

This rule does NOT cover:
- The auto-injected active-env section in `.cursor/rules/neotoma_cli.mdc` (managed by CLI session startup)
- Per-tool descriptions in `docs/developer/mcp/tool_descriptions.yaml`
- Format differences between the two files (the MCP file uses a plain-text code block; the CLI file uses markdown sections)

## Trigger Patterns

Apply this rule whenever:
- Any behavioral instruction is added, changed, or removed in either file
- A new category of behavior is introduced (e.g. new store pattern, new relationship type)
- Wording of an existing rule is corrected or clarified in one file

## Behavioral Sections That Must Stay in Parity

Each behavioral rule exists in both files with transport-appropriate wording. The following behaviors must be equivalent in both:

| Behavior | MCP anchor | CLI anchor |
|---|---|---|
| Chat persistence (MANDATORY) | `Chat (one call):` line | `MANDATORY in chat` bullet |
| Entity shapes (conversation, agent_message) | `Chat (one call):` line | `MANDATORY in chat` bullet |
| Stable turn identity (`turn_key`) | `Chat (one call):` line | `MANDATORY in chat` bullet |
| Observation history / branch overwriting | `Chat details:` line | `Chat details` bullet |
| Reverted turns (SUPERSEDES) | `Chat details:` line | `Chat details` bullet |
| Attachments | `Chat details:` line | `Chat details` bullet |
| Do not mention storage in thoughts | `Do not mention...` line | `Do not mention` bullet |
| Store-first rule (external tools) | `Other MCPs:` line | `External tool data` bullet |
| User identity | `User identity:` line | `User identity` bullet |
| Entity extraction | `Extract and store...` line | `Extract and store` bullet |
| Tasks | `Tasks:` line | `Tasks` bullet |
| Entity type discovery | `Entity types:` line | `Entity types` bullet |
| Conventions (pre-check, structured/unstructured path, summary) | `Conventions:` line | `Conventions` bullet |
| Relationship fallback | `Fallback if relationships...` line | `Relationship creation` section |

## Agent Actions

### When modifying either file

1. **Identify the changed behavior** — which category in the table above does it belong to?
2. **Locate the equivalent section in the other file** — use the anchor column in the table
3. **Apply the equivalent change** — reword for the transport (MCP tool calls vs CLI commands) but preserve the behavioral intent exactly
4. **Verify both files are updated before completing the task**

### Wording conventions

The MCP file is a dense plain-text code block (one instruction per line). The CLI file uses structured markdown with transport-branched wording (`**MCP:** ... **CLI:** ...`). Translate between them:

- MCP action names (`store_structured`, `create_relationship`) → CLI equivalents (`neotoma --servers=start store --json='...'`, `neotoma --servers=start relationships create ...`)
- MCP `list_entity_types` → CLI `neotoma --servers=start schemas list --search <keyword>`
- MCP `npm_check_update` → CLI `neotoma --servers=start --help` / update notifier
- Inline `relationships: [...]` in MCP store → separate `relationships create` call in CLI

### Files to update

When `docs/developer/mcp/instructions.md` changes:
- Update `docs/developer/cli_agent_instructions.md` (source of truth for CLI)
- The `.cursor/rules/neotoma_cli.mdc` Rule section is regenerated from the source doc on next CLI session start; if an immediate update is needed, edit `.cursor/rules/neotoma_cli.mdc` directly as well

When `docs/developer/cli_agent_instructions.md` changes:
- Update `docs/developer/mcp/instructions.md`
- Update `.cursor/rules/neotoma_cli.mdc` Rule section directly (same content as source doc)

## Constraints

- MUST update both files when behavioral instructions change in either one
- MUST NOT change the behavioral intent when translating between transports — only the commands differ
- MUST NOT add CLI-specific operational sections (e.g. `--servers=start` protocol, `--json=` syntax warning, active-env block) to `mcp/instructions.md`
- MUST NOT add MCP-specific internals (e.g. `source_index`/`target_index` for inline relationships, `file_content+mime_type` parameters) to the CLI file beyond what is needed for behavioral equivalence
- MUST verify both files are updated before marking the task complete

## Related Documents

- `docs/developer/mcp/instructions.md` — MCP instruction source
- `docs/developer/cli_agent_instructions.md` — CLI instruction source
- `.cursor/rules/neotoma_cli.mdc` — applied CLI rule file (auto-updated by CLI session startup)
- `docs/developer/agent_cli_configuration.md` — CLI/MCP strategy overview