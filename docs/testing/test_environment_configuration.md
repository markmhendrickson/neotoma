# Test Environment Configuration Guide

**Date**: 2026-01-23  
**Purpose**: Document exact environment configuration needed for running Neotoma tests

## Overview

This document explains the environment configuration required for running unit tests, integration tests, and E2E tests in the Neotoma project.

## Environment Variables

### Automatically Configured by vitest.setup.ts

These variables are automatically set if not present in `.env`:

```bash
# OpenAI API key for LLM extraction tests
OPENAI_API_KEY=test-openai-key

# MCP OAuth token encryption key (auto-generated 32-byte hex)
MCP_TOKEN_ENCRYPTION_KEY=<auto-generated-hex-key>

# OAuth client ID for OAuth 2.1 Server tests
SUPABASE_OAUTH_CLIENT_ID=test-client-id

# MCP authentication bypass for integration tests (NEW)
NEOTOMA_CONNECTION_ID=test-connection-bypass
```

### Required in .env File

These must be present in your `.env` file:

```bash
# Supabase Configuration (REQUIRED)
SUPABASE_PROJECT_ID=your-project-id
SUPABASE_SERVICE_KEY=your-service-role-key

# Alternative (if not using PROJECT_ID):
# SUPABASE_URL=https://your-project-id.supabase.co
# SUPABASE_SERVICE_KEY=your-service-role-key
```

**Where to find:**
- **Project ID**: Supabase Dashboard → Settings → General → Reference ID
- **Service Role Key**: Supabase Dashboard → Settings → API → service_role (secret)

### Optional Variables

```bash
# HTTP Server ports
HTTP_PORT=8080
PORT=3000

# OpenAI (if running LLM extraction tests with real API)
OPENAI_API_KEY=sk-your-real-key

# MCP OAuth (if running OAuth flow tests with real OAuth)
SUPABASE_OAUTH_CLIENT_ID=your-oauth-client-id
MCP_TOKEN_ENCRYPTION_KEY=your-32-byte-hex-key
```

## Authentication Bypass for Tests

### How It Works

1. **vitest.setup.ts** sets `NEOTOMA_CONNECTION_ID=test-connection-bypass`
2. **src/server.ts** recognizes this in test environment (NODE_ENV=test or VITEST=true)
3. **Server sets** `authenticatedUserId = "00000000-0000-0000-0000-000000000000"`
4. **Tests can call** MCP actions without OAuth flow

### Code Changes Made

**File: vitest.setup.ts** (lines 24-28)
```typescript
// Set test MCP authentication (for MCP server action tests)
if (!process.env.NEOTOMA_CONNECTION_ID && !process.env.NEOTOMA_SESSION_TOKEN) {
  // Use a test connection ID that bypasses authentication in test environment
  process.env.NEOTOMA_CONNECTION_ID = "test-connection-bypass";
}
```

**File: src/server.ts** (after line 114, in initialize method)
```typescript
// In test environment, allow test connection ID to bypass authentication
// Check for test environment via NODE_ENV (vitest sets this) or explicit test connection ID
const isTestEnv = process.env.NODE_ENV === "test" || process.env.VITEST === "true";
if (connectionId === "test-connection-bypass" && isTestEnv) {
  // Use default test user ID
  this.authenticatedUserId = "00000000-0000-0000-0000-000000000000";
  this.requestAuth.set(requestId, { 
    userId: this.authenticatedUserId, 
    token: "test-bypass-token" 
  });
  
  logger.error(`[MCP Server] Using test authentication bypass (user: ${this.authenticatedUserId})`);
  
  return {
    protocolVersion: "2025-11-25",
    capabilities: {
      tools: {},
      resources: {},
    },
    serverInfo: {
      name: "neotoma",
      version: "1.0.0",
    },
  };
}
```

### Alternative: Direct Auth Assignment

For tests that create NeotomaServer directly, set authenticated user:

```typescript
beforeAll(async () => {
  server = new NeotomaServer();
  
  // Set authenticated user ID directly for tests (bypasses OAuth)
  (server as any).authenticatedUserId = testUserId;
});
```

## RLS Bypass for Integration Tests

### Problem

Row Level Security (RLS) policies prevent entity insertions in tests using regular client.

### Solution

Use service role client for test data setup:

```typescript
import { createClient } from "@supabase/supabase-js";
import { config } from "../../src/config.js";

// Create service role client (bypasses RLS)
const serviceRoleClient = createClient(config.supabaseUrl, config.supabaseKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false,
  },
});

// Use for test data setup
const { data: entity } = await serviceRoleClient
  .from("entities")
  .insert({
    id: `ent_test_${Date.now()}`, // Must provide ID
    user_id: testUserId,
    entity_type: "company",
    canonical_name: "test company",
  })
  .select()
  .single();
```

**Reference**: See `tests/integration/mcp_oauth_flow.test.ts` for working example.

### Files Updated

- `tests/integration/entity_queries.test.ts` - Now uses serviceRoleClient
- `tests/integration/observation_ingestion.test.ts` - Fixed table names, added error handling

## Table Name Migrations

### sources Table (not "source")

**Correct:**
```typescript
await supabase.from("sources").insert({
  user_id: testUserId,
  original_filename: "test.json",
  mime_type: "application/json",
  file_size: 100,
  content_hash: "unique-hash",
})
```

**Wrong:**
```typescript
// This table doesn't exist
await supabase.from("source").insert({ ... })
```

### raw_fragments Table Columns

**Correct column name:** `entity_type`

**Wrong:** `fragment_type` (this column was renamed in migration)

```typescript
// Correct
await supabase.from("raw_fragments").insert({
  entity_type: "task",
  fragment_key: "field_name",
  fragment_value: "value",
  user_id: testUserId,
  frequency_count: 1,
})
```

## Running Tests

### Unit Tests Only

```bash
npm test -- tests/services/
```

**Requirements:**
- Basic .env with SUPABASE_PROJECT_ID and SUPABASE_SERVICE_KEY
- No authentication needed (unit tests don't call database)

### Integration Tests

```bash
npm run test:integration
```

**Requirements:**
- .env with Supabase configuration
- NEOTOMA_CONNECTION_ID set (auto-set by vitest.setup.ts)
- Database migrations applied
- Service role key for RLS bypass

### E2E Tests

```bash
npm run test:e2e
```

**Requirements:**
- All integration test requirements
- Frontend running (or mocked API server)
- Browser automation setup (Playwright)

### Full Test Suite with Coverage

```bash
npm run test:coverage
```

**Requirements:**
- All above requirements
- Sufficient test data in database
- All migrations applied

## Test User ID

Default test user ID used across tests:

```
00000000-0000-0000-0000-000000000000
```

This is the default UUID that:
- Bypasses authentication in test mode
- Used consistently across all test files
- Allows test data isolation and cleanup

## Troubleshooting

### Authentication Required Error

**Error**: "Authentication required. Set NEOTOMA_CONNECTION_ID..."

**Solution**:
1. Verify `vitest.setup.ts` sets `NEOTOMA_CONNECTION_ID=test-connection-bypass`
2. Verify `src/server.ts` has test bypass logic
3. For tests creating NeotomaServer directly, set `(server as any).authenticatedUserId = testUserId;`

### Cannot Insert into entities

**Error**: RLS policy blocks insert

**Solution**: Use service role client:
```typescript
const serviceRoleClient = createClient(config.supabaseUrl, config.supabaseKey, {
  auth: { autoRefreshToken: false, persistSession: false },
});
```

### Table Not Found Errors

**Common issues:**
- `source` should be `sources` (plural)
- `fragment_type` should be `entity_type` in raw_fragments
- `interpretation_runs` renamed to `interpretations`

**Solution**: Check migration status and use correct table/column names.

### Foreign Key Violations

**Error**: "violates foreign key constraint"

**Common cause**: Trying to insert with non-existent user_id

**Solution**:
- Use `null` for global entities
- Use default test UUID: `00000000-0000-0000-0000-000000000000`
- Create test users via `supabase.auth.admin.createUser()` first

## Test Data Cleanup

All integration tests should clean up after themselves:

```typescript
afterEach(async () => {
  if (createdEntityIds.length > 0) {
    await supabase.from("entities").delete().in("id", createdEntityIds);
    createdEntityIds.length = 0;
  }
});
```

**Cleanup order matters:**
1. Delete child records first (observations, events, relationships)
2. Delete parent records last (entities, sources)
3. Use service role client for cleanup if RLS blocks deletion

## Files Modified for Environment Config

1. **vitest.setup.ts** - Added NEOTOMA_CONNECTION_ID bypass
2. **src/server.ts** - Added test environment check
3. **tests/integration/entity_queries.test.ts** - Use service role client
4. **tests/integration/observation_ingestion.test.ts** - Fixed table names
5. **tests/integration/mcp_auto_enhancement.test.ts** - Direct auth assignment

## Verification

Run quick verification:

```bash
# Unit tests (should pass)
npm test -- tests/services/entity_resolution.test.ts --run
npm test -- tests/services/search.test.ts --run

# Integration tests (should pass with config)
npm test -- tests/integration/dashboard_stats.test.ts --run
npm test -- tests/integration/observation_ingestion.test.ts --run

# Full suite
npm test
```

Expected results:
- Unit tests: 81+ new tests passing
- Integration tests: 92+ new tests (some may skip if sources table unavailable)
- E2E tests: 62+ new tests (require running servers)

## Related Documents

- `docs/testing/test_coverage_audit_summary.md` - Complete test coverage audit
- `docs/reports/AUTO_ENHANCEMENT_TEST_COVERAGE_GAPS.md` - Original gap analysis
- `docs/developer/getting_started.md` - Initial environment setup
- `env.example` - Example environment variables
