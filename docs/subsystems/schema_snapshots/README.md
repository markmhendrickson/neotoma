# Schema Snapshots — Public Schema Registry Reference
This directory contains exported snapshots of all schema versions from the `schema_registry` database table. These snapshots provide public reference to schema definitions without requiring database access.
## Purpose
- **Public Reference**: View schema definitions without database access
- **Version Control**: Track schema evolution over time in git history
- **Documentation**: Reference schemas in documentation and examples
- **Review**: Easier PR review of schema changes
- **Testing**: Use snapshots for validation and testing
- **Source of Truth**: Exports from `src/services/schema_definitions.ts` (code definitions)
## Structure
Each entity type has its own directory containing versioned schema files:
```
schema_snapshots/
  ├── README.md                    # This file
  ├── invoice/
  │   ├── v1.0.json               # Schema definition + reducer config
  │   └── v1.1.json
  ├── person/
  │   └── v1.0.json
  └── company/
      └── v1.0.json
```
## File Format
Each snapshot file contains the complete schema registry entry:
```json
{
  "entity_type": "invoice",
  "schema_version": "1.0",
  "active": true,
  "created_at": "2024-01-15T10:30:00Z",
  "schema_definition": {
    "fields": {
      "vendor_name": {
        "type": "string",
        "required": true,
        "description": "Vendor company name"
      }
    }
  },
  "reducer_config": {
    "merge_policies": {
      "vendor_name": {
        "strategy": "highest_priority"
      }
    }
  }
}
```
## Exporting Schemas
To export all schemas from `schema_definitions.ts` to this directory:
```bash
npm run schema:export
```
Or run the script directly:
```bash
tsx scripts/export_schema_snapshots.ts
```
The script will:
1. Read latest schema definitions from `src/services/schema_definitions.ts` (source of truth for current code)
2. Fetch all schema versions from `schema_registry` database table (including historic versions)
3. Merge both sources:
   - Latest versions use definitions from code (authoritative)
   - Historic versions are preserved from database (for reference)
   - Database metadata (active status, created_at) is merged into code schemas
4. Create entity type directories if needed
5. Write each version to `{entity_type}/v{version}.json`
6. Update this README with a changelog
**Note**: The export combines both sources:
- **Latest schemas** come from code (`schema_definitions.ts`) - ensures snapshots reflect current code
- **Historic schemas** come from database - preserves version history even if code only has latest
- This provides complete version history while ensuring latest definitions match code
## Updating Snapshots
**Automatic Export:**
Schema snapshots are **automatically exported** whenever schemas are updated via the schema registry service:
- After `schemaRegistry.register()` - exports all schemas
- After `schemaRegistry.activate()` - exports all schemas
- After `schemaRegistry.deactivate()` - exports all schemas
The export runs asynchronously in the background and does not block schema operations. Export failures are silently ignored to ensure schema operations always succeed.
**Manual Export:**
You can also manually export schemas at any time:
```bash
npm run schema:export
```
**Update process:**
1. Register/activate schema in database (via `schemaRegistry.register()` or `schemaRegistry.activate()`)
2. Snapshots are automatically exported in the background
3. Review generated files in `docs/subsystems/schema_snapshots/`
4. Commit both database changes and snapshot files
## Active Schemas
The `active` field in each snapshot indicates whether that version is currently active. Only one version per entity type should be active at a time.
To find the active schema for an entity type:
```bash
# Using jq
cat invoice/v1.1.json | jq '.active'
# Or grep
grep -l '"active": true' invoice/*.json
```
## Schema Evolution
Schema versions follow semantic versioning:
- `1.0` — Initial version
- `1.1` — Additive changes (new fields)
- `2.0` — Major changes (breaking changes avoided in MVP)
See [`schema_registry.md`](../schema_registry.md) for complete schema versioning documentation.
## Changelog

<!-- Auto-generated by export script -->
_Last updated: 2026-01-08T15:02:06.055Z_

### account
- **v1.0** **(active)**: 2026-01-08

### address
- **v1.0** **(active)**: 2026-01-08

### balance
- **v1.0** **(active)**: 2026-01-08

### company
- **v1.0** **(active)**: 2026-01-08

### contact
- **v1.1** **(active)**: 2026-01-08

### contract
- **v1.0** **(active)**: 2026-01-08

### crypto_transaction
- **v1.0** **(active)**: 2026-01-08

### email
- **v1.0** **(active)**: 2026-01-08

### event
- **v1.0** **(active)**: 2026-01-08

### exercise
- **v1.0** **(active)**: 2026-01-08

### fixed_cost
- **v1.0** **(active)**: 2026-01-08

### flow
- **v1.0** **(active)**: 2026-01-08

### goal
- **v1.0** **(active)**: 2026-01-08

### holding
- **v1.0** **(active)**: 2026-01-08

### income
- **v1.0** **(active)**: 2026-01-08

### liability
- **v1.0** **(active)**: 2026-01-08

### location
- **v1.0** **(active)**: 2026-01-08

### meal
- **v1.0** **(active)**: 2026-01-08

### message
- **v1.0** **(active)**: 2026-01-08

### note
- **v1.0** **(active)**: 2026-01-08

### order
- **v1.0** **(active)**: 2026-01-08

### person
- **v1.0** **(active)**: 2026-01-08

### project
- **v1.0** **(active)**: 2026-01-08

### property
- **v1.0** **(active)**: 2026-01-08

### purchase
- **v1.0** **(active)**: 2026-01-08

### relationship
- **v1.0** **(active)**: 2026-01-08

### task
- **v1.0** **(active)**: 2026-01-08

### tax_event
- **v1.0** **(active)**: 2026-01-08

### tax_filing
- **v1.0** **(active)**: 2026-01-08

### transaction
- **v1.0** **(active)**: 2026-01-08

### transfer
- **v1.0** **(active)**: 2026-01-08

### wallet
- **v1.0** **(active)**: 2026-01-08
