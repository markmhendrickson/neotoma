release:
  id: v0.2.0
  name: Minimal Ingestion + Correction Loop
  type: "not_marketed" # marketed | not_marketed
  priority: P0
  status: planning
  target_ship_date: null # Before v0.3.0 (Operational Hardening) and v1.0.0
  owner: Mark Hendrickson
  marketing_required: false
  guiding_principle: "Ship the minimal ingestion + correction loop that proves real usage before adding safety nets"

# Execution strategy
execution_strategy:
  type: "multi_agent" # "multi_agent" or "sequential"
  max_parallel_fus: 2 # Maximum FUs executing simultaneously
  max_high_risk_in_parallel: 1 # Maximum high-risk FUs executing simultaneously
  agent_spawning:
    enabled: true
    status_tracking: "file" # "file" or "api"
    status_file: "docs/releases/v0.2.0/agent_status.json"

feature_units:
  # Phase 1: Core Schema + RLS
  - id: FU-110
    name: Sources Table Migration
    priority: P0
    status: not_started
    dependencies: []
    phase: 1
    description: Content-addressed raw storage with RLS

  - id: FU-111
    name: Interpretation Runs Table
    priority: P0
    status: not_started
    dependencies: [FU-110]
    phase: 1
    description: Versioned interpretation tracking with config logging (no timeout columns in v0.2.0)

  - id: FU-113
    name: Entity Extensions
    priority: P0
    status: not_started
    dependencies: []
    phase: 1
    description: user_id, merged_to tracking, RLS

  - id: FU-114
    name: Observation Extensions
    priority: P0
    status: not_started
    dependencies: [FU-110, FU-111]
    phase: 1
    description: source_id, interpretation_run linkage

  - id: FU-115
    name: Raw Fragments Extensions
    priority: P0
    status: not_started
    dependencies: [FU-110, FU-111]
    phase: 1
    description: Unknown field storage with provenance

  - id: FU-116
    name: Entity Merges Table
    priority: P0
    status: not_started
    dependencies: [FU-113]
    phase: 1
    description: Merge audit log with TEXT IDs

  # Phase 2: Minimal MCP Tools + Services
  - id: FU-120
    name: Raw Storage Service
    priority: P0
    status: not_started
    dependencies: [FU-110]
    phase: 2
    description: SHA-256 hashing, Supabase Storage (synchronous only, no queue)

  - id: FU-121
    name: Interpretation Service
    priority: P0
    status: not_started
    dependencies: [FU-111, FU-114, FU-115]
    phase: 2
    description: Strict JSON schema validation, entity resolution, unknown field routing

  - id: FU-122
    name: MCP ingest() Tool
    priority: P0
    status: not_started
    dependencies: [FU-120, FU-121]
    phase: 2
    description: Raw ingestion with optional interpretation

  - id: FU-123
    name: MCP ingest_structured() Tool
    priority: P0
    status: not_started
    dependencies: [FU-121]
    phase: 2
    description: Pre-structured data with schema validation

  - id: FU-124
    name: MCP reinterpret() Tool
    priority: P0
    status: not_started
    dependencies: [FU-121]
    phase: 2
    description: Versioned re-interpretation with simple quota check

  - id: FU-125
    name: MCP correct() Tool
    priority: P0
    status: not_started
    dependencies: [FU-121]
    phase: 2
    description: High-priority correction observations

  - id: FU-126
    name: MCP merge_entities() Tool
    priority: P0
    status: not_started
    dependencies: [FU-113, FU-116]
    phase: 2
    description: Manual entity deduplication with cascade updates

  # Phase 3: Query + Integration
  - id: FU-134
    name: Query Updates
    priority: P0
    status: not_started
    dependencies: [FU-110, FU-113, FU-114]
    phase: 3
    description: Provenance chain, merged entity exclusion

deferred_to_v030:
  - id: FU-112
    name: Storage Infrastructure
    description: Upload queue, storage usage tracking, quotas
    reason: Don't optimize throughput before confirming adoption

  - id: FU-130
    name: Upload Queue Processor
    description: Async retry for failed uploads
    reason: Not needed until real failure patterns emerge

  - id: FU-131
    name: Stale Interpretation Cleanup
    description: Timeout handling for hung jobs
    reason: Not needed until real usage patterns

deferred_to_v040:
  - id: FU-132
    name: Archival Job
    description: Old interpretation run archival
    reason: Only valuable with volume/diversity of data

  - id: FU-133
    name: Duplicate Detection Worker
    description: Heuristic duplicate flagging
    reason: Heuristics need data to justify

scope:
  included:
    - FU-110, FU-111, FU-113-116: Core Schema + RLS
    - FU-120 through FU-126: Minimal MCP Tools + Services
    - FU-134: Query Updates

  deferred_v030:
    - FU-112: Storage Infrastructure (upload queue, storage usage)
    - FU-130: Upload Queue Processor
    - FU-131: Stale Interpretation Cleanup
    - Advanced quota tiers and billing automation

  deferred_v040:
    - FU-132: Archival Job
    - FU-133: Duplicate Detection Worker
    - Schema discovery/promotion from raw_fragments

  deferred_v1x:
    - Semantic search integration
    - Model-selection UI
    - Multi-user organization features

  excluded:
    - Automated entity merge suggestions
    - Schema evolution UI

acceptance_criteria:
  product:
    - Raw files can be ingested and content-addressed
    - Interpretation runs are versioned and auditable
    - Users can correct AI-extracted fields
    - Duplicate entities can be merged manually
    - All data is user-isolated

  technical:
    - All new tables created with RLS policies
    - Sources table with content hash uniqueness per user
    - Entities extended with user_id and merge tracking
    - MCP tools functional (ingest, ingest_structured, reinterpret, correct, merge_entities)
    - Unit and integration tests passing
    - NO background workers in v0.2.0

  business:
    - Core ingestion + correction loop validated with real usage
    - User data isolation satisfies privacy requirements
    - Interpretation auditability enables trust and debugging

success_criteria:
  - All migrations applied successfully
  - RLS policies enforced on all user tables
  - All MCP tools functional (synchronous operations only)
  - Cross-user isolation verified
  - All tests passing
  - Validation goal: "Users/agents can ingest, re-interpret, correct, and merge on real data"

determinism_doctrine:
  principle: "Deterministic given fixed source, interpretation config, and resolver version"
  
  deterministic_core:
    - Content hashing (SHA-256)
    - Deduplication (user_id, content_hash uniqueness)
    - Storage path (user_id/content_hash)
    - Observation creation (given fixed validated fields + entity_id)
    - Reducer computation
    - Entity merge

  non_deterministic_boundary:
    - AI interpretation: Config logged (provider, model_id, temperature, prompt_hash, code_version); versioned and auditable
    - Entity resolution: Heuristic; resolver version tracked in provenance

  validation:
    - Strict JSON schema validation at ingestion boundary
    - Reject/quarantine records with invalid shapes
    - Provenance mandatory: source_id and interpretation_run enforced
