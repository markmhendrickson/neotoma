openapi: 3.1.0
info:
  title: Neotoma API
  version: 1.0.0
  description: REST wrapper for Neotoma enabling ChatGPT Actions.
servers:
  - url: https://dev.neotoma.io
    description: Cloudflare Tunnel URL
security:
  - bearerAuth: []
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: base64url
      description: |
        Bearer token is a base64url-encoded Ed25519 public key.
        The corresponding private key is used by the client to decrypt responses.
        For ChatGPT Actions, use the public key (base64url-encoded) as the bearer token.
        Optional: Include request signature in Authorization header: "Bearer <public_key> Signature <signature>"
  schemas:
    StoreRecordRequest:
      type: object
      required: [type, properties]
      properties:
        type:
          type: string
          description: Record type identifier (e.g., note, transaction)
        properties:
          type: object
          additionalProperties: true
          minProperties: 0
          properties: {}
          description: REQUIRED - Arbitrary key/value properties stored in JSONB. Must be an object. Can be empty.
        file_urls:
          type: array
          items: { type: string }
          description: Optional array of storage paths for associated files
        embedding:
          type: array
          items: { type: number }
          description: |
            RECOMMENDED: Generate 1536-dimensional embedding client-side using OpenAI text-embedding-3-small before calling this endpoint.
            - Generate from: JSON.stringify(properties) plus space plus type
            - If you generate and include this field, must be non-empty array of exactly 1536 numbers.
            - Do NOT send empty array. Omit field entirely if not generating client-side.
            - Server will auto-generate if omitted (requires OPENAI_API_KEY on server).
            Generation example: Use OpenAI embeddings.create with model text-embedding-3-small and input JSON.stringify(properties) plus space plus type
    StoreRecordsRequest:
      type: object
      required: [records]
      properties:
        records:
          type: array
          items:
            $ref: '#/components/schemas/StoreRecordRequest'
          minItems: 1
          maxItems: 100
          description: Array of records to create (1-100 items)
    UpdateRecordRequest:
      type: object
      required: [id]
      properties:
        id:
          type: string
          description: Record ID to update
        type:
          type: string
          description: Optional - Update the record type
        properties:
          type: object
          additionalProperties: true
          minProperties: 0
          properties: {}
          description: Properties to update (merges with existing)
        file_urls:
          type: array
          items: { type: string }
          description: Optional array of storage paths for associated files
        embedding:
          type: array
          items: { type: number }
          description: |
            RECOMMENDED: Generate 1536-dimensional embedding client-side using OpenAI text-embedding-3-small before calling.
            - Generate from: JSON.stringify(updated properties) plus space plus updated type or existing type
            - If provided, must be non-empty array of exactly 1536 numbers.
            - Do NOT send empty array. Omit field entirely if not generating.
            - Server auto-generates if omitted (requires OPENAI_API_KEY on server).
    RetrieveRecordsRequest:
      type: object
      properties:
        type:
          type: string
          description: Filter by record type
        properties:
          type: object
          additionalProperties: true
          minProperties: 0
          properties: {}
          description: Filter by property values (simple top-level key matching)
        limit:
          type: integer
          description: Maximum number of results (default 100, max 500)
        search:
          type: array
          items: { type: string }
          description: Search terms for fuzzy/semantic matching (requires query_embedding for semantic mode)
        search_mode:
          type: string
          enum: [semantic, keyword, both]
          default: both
          description: Search mode - semantic uses vector embeddings, keyword uses text matching, both combines results
        similarity_threshold:
          type: number
          minimum: 0
          maximum: 1
          default: 0.3
          description: Minimum cosine similarity score for semantic search (0 = no similarity, 1 = identical). Typical scores range 0.3-0.5 for related content.
        query_embedding:
          type: array
          items: { type: number }
          description: |
            RECOMMENDED: Generate 1536-dimensional embedding client-side using OpenAI text-embedding-3-small from search terms.
            - Generate from: search.join with space separator or search array elements combined
            - If you generate and include this field, must be non-empty array of exactly 1536 numbers.
            - Do NOT send empty array. Omit field entirely if not generating client-side.
            - Server will auto-generate if omitted (requires OPENAI_API_KEY on server).
            Generation example: Use OpenAI embeddings.create with model text-embedding-3-small and input search.join with space separator
    DeleteRecordRequest:
      type: object
      required: [id]
      properties:
        id:
          type: string
          description: Record ID to delete
    DeleteRecordResponse:
      type: object
      properties:
        success:
          type: boolean
        deleted_id:
          type: string
    DeleteRecordsRequest:
      type: object
      required: [ids]
      properties:
        ids:
          type: array
          items: { type: string }
          minItems: 1
          maxItems: 100
          description: Array of record IDs to delete (1-100 items)
    DeleteRecordsResponse:
      type: object
      properties:
        success:
          type: boolean
        deleted_ids:
          type: array
          items: { type: string }
        count:
          type: integer
          description: Number of records deleted
    UploadFileRequest:
      type: object
      required: [file]
      properties:
        record_id:
          type: string
          description: Existing record ID to attach the file to. Omit to create a new record.
        bucket:
          type: string
          description: Storage bucket name (optional, defaults to 'files').
        properties:
          type: string
          description: "Optional JSON object to use as properties when creating a new record. If provided, automatic analysis is skipped."
        csv_row_records:
          type: boolean
          description: "Optional flag for CSV uploads. Defaults to true. Set to false to skip creating per-row records linked to the dataset."
        file:
          type: string
          format: binary
          description: File to upload
    FileUrlResponse:
      type: object
      properties:
        url:
          type: string
          description: Signed URL for accessing the file
    Record:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        properties:
          type: object
          additionalProperties: true
          minProperties: 0
          properties: {}
          description: Arbitrary key/value properties stored in JSONB
        file_urls:
          type: array
          items: { type: string }
        embedding:
          type: array
          items: { type: number }
          description: "1536-dimensional embedding vector (if provided). Note: Embeddings are excluded from responses to reduce payload size."
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Error:
      type: object
      properties:
        error:
          type: string
    GroomPreviewRequest:
      type: object
      required: [rows]
      properties:
        rows:
          type: array
          items: { type: object, additionalProperties: true }
          minItems: 1
          maxItems: 2000
    GroomPreviewResponse:
      type: object
      properties:
        normalized:
          type: array
          items:
            $ref: '#/components/schemas/StoreRecordRequest'
        suggestions:
          type: object
          properties:
            existingTypes:
              type: array
              items: { type: string }
            dateFields:
              type: array
              items: { type: string }
        warnings:
          type: array
          items: { type: string }
    GroomAssistRequest:
      type: object
      required: [messages]
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'
          minItems: 1
        sample:
          type: array
          items:
            type: object
            additionalProperties: true
        existingTypes:
          type: array
          items: { type: string }
    GroomAssistResponse:
      type: object
      properties:
        message:
          $ref: '#/components/schemas/ChatMessage'
    GroomTransformRequest:
      type: object
      required: [rows]
      properties:
        rows:
          type: array
          items:
            type: object
            additionalProperties: true
          minItems: 1
        instruction:
          type: string
          description: Optional natural-language instruction for the transformation model
        return:
          type: string
          enum: [json, file]
          default: json
          description: Choose "file" to download a JSON payload instead of inline response
    GroomTransformResponse:
      type: object
      properties:
        rows:
          type: array
          items:
            $ref: '#/components/schemas/StoreRecordRequest'
    SandboxConfigResponse:
      type: object
      properties:
        user_id_default:
          type: string
        client_name_default:
          type: string
        products_default:
          type: string
          description: Comma-separated products list
        redirect_uri_default:
          type: string
    AnalyzeFileResponse:
      type: object
      properties:
        type:
          type: string
          description: Inferred canonical record type
        properties:
          type: object
          additionalProperties: true
          description: Structured fields extracted from the file
        summary:
          type: string
          description: Human-readable summary of the file contents
    PlaidLinkTokenRequest:
      type: object
      properties:
        user_id:
          type: string
          description: Optional; defaults to PLAID_LINK_USER_ID if omitted
        client_name:
          type: string
          description: Optional; defaults to PLAID_LINK_CLIENT_NAME if omitted
        access_token:
          type: string
          nullable: true
        products:
          type: array
          items: { type: string }
        redirect_uri:
          type: string
    PlaidLinkTokenResponse:
      type: object
      properties:
        link_token:
          type: string
        expiration:
          type: string
          format: date-time
        request_id:
          type: string
    PlaidAccountSummary:
      type: object
      properties:
        account_id: { type: string }
        name: { type: string }
        official_name: { type: string, nullable: true }
        mask: { type: string, nullable: true }
        type: { type: string }
        subtype: { type: string, nullable: true }
        balances:
          type: object
          properties:
            available: { type: number, nullable: true }
            current: { type: number, nullable: true }
            iso_currency_code: { type: string, nullable: true }
            unofficial_currency_code: { type: string, nullable: true }
    PlaidInstitutionSummary:
      type: object
      properties:
        id: { type: string, nullable: true }
        name: { type: string, nullable: true }
        url: { type: string, nullable: true }
        primary_color: { type: string, nullable: true }
    PlaidItem:
      type: object
      properties:
        id: { type: string }
        item_id: { type: string }
        institution_id: { type: string, nullable: true }
        institution_name: { type: string, nullable: true }
        environment: { type: string }
        products:
          type: array
          items: { type: string }
        country_codes:
          type: array
          items: { type: string }
        cursor: { type: string, nullable: true }
        webhook_status: { type: string, nullable: true }
        last_successful_sync:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    PlaidExchangePublicTokenRequest:
      type: object
      required: [public_token]
      properties:
        public_token:
          type: string
        trigger_initial_sync:
          type: boolean
    PlaidSyncSummary:
      type: object
      properties:
        plaidItemId: { type: string }
        addedTransactions: { type: integer }
        modifiedTransactions: { type: integer }
        removedTransactions: { type: integer }
        createdRecords: { type: integer }
        updatedRecords: { type: integer }
        removedRecordUpdates: { type: integer }
        nextCursor: { type: string }
        lastSuccessfulSync:
          type: string
          format: date-time
    PlaidExchangePublicTokenResponse:
      type: object
      properties:
        item:
          $ref: '#/components/schemas/PlaidItem'
        institution:
          $ref: '#/components/schemas/PlaidInstitutionSummary'
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/PlaidAccountSummary'
        request_id:
          type: string
        initial_sync:
          oneOf:
            - $ref: '#/components/schemas/PlaidSyncSummary'
            - type: 'null'
    PlaidSyncRequest:
      type: object
      properties:
        plaid_item_id:
          type: string
          format: uuid
        item_id:
          type: string
        sync_all:
          type: boolean
        force_full_sync:
          type: boolean
    PlaidSyncResponse:
      type: object
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              item:
                $ref: '#/components/schemas/PlaidItem'
              summary:
                $ref: '#/components/schemas/PlaidSyncSummary'
    PlaidItemsResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PlaidItem'
    PlaidErrorResponse:
      type: object
      properties:
        error:
          type: object
          additionalProperties: true
    PlaidPreviewSyncRequest:
      type: object
      properties:
        plaid_item_id:
          type: string
          format: uuid
        item_id:
          type: string
        all:
          type: boolean
          description: Set true to preview all stored Plaid items
    PlaidPreviewSummary:
      type: object
      properties:
        plaidItemId: { type: string }
        itemId: { type: string }
        institutionId: { type: string, nullable: true }
        institutionName: { type: string, nullable: true }
        lastSuccessfulSync:
          type: string
          format: date-time
          nullable: true
        cursor: { type: string, nullable: true }
        added: { type: integer }
        modified: { type: integer }
        removed: { type: integer }
        nextCursor: { type: string }
    PlaidPreviewSyncResponse:
      type: object
      properties:
        previews:
          type: array
          items:
            $ref: '#/components/schemas/PlaidPreviewSummary'
        count:
          type: integer
          description: Number of items previewed
    ChatMessage:
      type: object
      properties:
        role:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
      required: [role, content]
    ChatRequest:
      type: object
      required: [messages]
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'
          minItems: 1
        model:
          type: string
          description: Optional model override (default: gpt-4o-mini)
        temperature:
          type: number
          minimum: 0
          maximum: 2
          description: Optional temperature override (default: 0.7)
    ChatResponse:
      type: object
      properties:
        message:
          $ref: '#/components/schemas/ChatMessage'
        records_queried:
          type: array
          items:
            $ref: '#/components/schemas/Record'
          description: Records that were queried during the conversation (if any)
        function_calls:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              arguments:
                type: object
                additionalProperties: true
          description: Function calls made during the conversation (if any)
paths:
  /types:
    get:
      summary: List existing record types
      operationId: listTypes
      responses:
        '200':
          description: Distinct record types
          content:
            application/json:
              schema:
                type: object
                properties:
                  types:
                    type: array
                    items: { type: string }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /groom/preview:
    post:
      summary: Normalize preview for raw CSV rows
      operationId: groomPreview
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/GroomPreviewRequest' }
      responses:
        '200':
          description: Normalized rows with suggestions and warnings
          content:
            application/json:
              schema: { $ref: '#/components/schemas/GroomPreviewResponse' }
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /groom/finalize:
    post:
      summary: Finalize and save normalized records in batches
      operationId: groomFinalize
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/StoreRecordsRequest' }
      responses:
        '200':
          description: Save summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  count: { type: integer }
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /groom/assist:
    post:
      summary: Get AI-assisted normalization guidance for staged rows
      operationId: groomAssist
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/GroomAssistRequest' }
      responses:
        '200':
          description: Assistant response with structured guidance
          content:
            application/json:
              schema: { $ref: '#/components/schemas/GroomAssistResponse' }
        '400':
          description: Invalid payload or model unavailable
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream OpenAI API error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /groom/transform:
    post:
      summary: Apply bulk transformations to staged rows (optionally returning a file)
      operationId: groomTransform
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/GroomTransformRequest' }
      responses:
        '200':
          description: Transformed rows (JSON response; if `return=file` a downloadable JSON file is sent)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/GroomTransformResponse' }
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream OpenAI API error during transformation
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /sandbox/config:
    get:
      summary: Provide safe default values for the Sandbox UI
      operationId: sandboxConfig
      security: []
      responses:
        '200':
          description: Default Plaid sandbox configuration values
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SandboxConfigResponse' }
  /store_record:
    post:
      summary: Create new record
      description: >
        RECOMMENDED: Generate embedding client-side using OpenAI text-embedding-3-small before calling.
        Input should be JSON.stringify(properties) plus space plus type.
        Server auto-generates if omitted. Body must include type and properties (object).
        Use the example as a template.
      operationId: storeRecord
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StoreRecordRequest'
            example:
              type: note
              properties:
                title: "Test note"
                content: "This is a stored test note."
      responses:
        '200':
          description: Created record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Record'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /store_records:
    post:
      summary: Create multiple records in bulk
      description: >
        RECOMMENDED: Generate embeddings client-side for each record using OpenAI text-embedding-3-small before calling.
        Server auto-generates if omitted. Accepts an array of records (1-100 items).
      operationId: storeRecords
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StoreRecordsRequest'
            example:
              records:
                - type: note
                  properties:
                    title: "First note"
                    content: "Content of first note"
                - type: note
                  properties:
                    title: "Second note"
                    content: "Content of second note"
      responses:
        '200':
          description: Summary of created records (excludes embeddings to reduce response size)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  records:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        type:
                          type: string
                        created_at:
                          type: string
                          format: date-time
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /update_record:
    post:
      summary: Update existing record
      description: >
        RECOMMENDED: Generate embedding client-side if properties/type change using OpenAI text-embedding-3-small before calling.
        Input should be JSON.stringify(updated properties) plus space plus type.
        Server auto-generates if omitted. Provide the id of the record and partial fields to update.
      operationId: updateRecord
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRecordRequest'
            example:
              id: "f2d0f8e3-7f5d-4a3b-a3bb-9d9d5b7f0b11"
              type: "updated_type"
              properties:
                title: "Updated Title"
      responses:
        '200':
          description: Updated record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Record'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Record not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /retrieve_records:
    post:
      summary: Retrieve records with optional semantic search
      description: >
        Filter by type and/or match property values. RECOMMENDED: Generate query_embedding client-side from search terms using OpenAI text-embedding-3-small before calling.
        Server auto-generates if omitted. Use search_mode to control semantic vs keyword matching.
      operationId: retrieveRecords
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetrieveRecordsRequest'
            examples:
              client_provides_embedding:
                summary: Client generates embedding (recommended for production)
                description: Generate query_embedding client-side for better control and cost management
                value:
                  type: note
                  search: ["workout", "exercise"]
                  search_mode: semantic
                  query_embedding: [0.012, -0.034, 0.056]
                  similarity_threshold: 0.7
                  limit: 10
              server_generates_embedding:
                summary: Server generates embedding (requires OPENAI_API_KEY)
                description: Omit query_embedding to let server generate it automatically
                value:
                  type: note
                  search: ["workout", "exercise"]
                  search_mode: semantic
                  similarity_threshold: 0.7
                  limit: 10
      responses:
        '200':
          description: Array of records
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Record'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /delete_record:
    post:
      summary: Delete record
      description: Permanently remove a record by id.
      operationId: deleteRecord
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteRecordRequest'
            example:
              id: "f2d0f8e3-7f5d-4a3b-a3bb-9d9d5b7f0b11"
      responses:
        '200':
          description: Delete result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteRecordResponse'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /delete_records:
    post:
      summary: Delete multiple records in bulk
      description: Permanently remove multiple records by their IDs (1-100 records per request).
      operationId: deleteRecords
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteRecordsRequest'
            example:
              ids:
                - "f2d0f8e3-7f5d-4a3b-a3bb-9d9d5b7f0b11"
                - "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      responses:
        '200':
          description: Delete result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteRecordsResponse'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /upload_file:
    post:
      summary: Upload file and attach or create record
      description: |
        Send multipart/form-data with field `file` and optional `record_id`.
        If `record_id` is provided, the file is appended to the existing record's `file_urls`.
        When `record_id` is omitted, the server analyzes the file (via OpenAI when available) to infer `type` and `properties`,
        creates a new record, and associates the uploaded file. Provide an optional `properties` JSON field to bypass analysis
        and supply record properties manually. CSV uploads default to creating one record per row (set `csv_row_records=false`
        to skip) plus relationships back to the originating dataset record.
      operationId: uploadFile
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UploadFileRequest'
      responses:
        '200':
          description: Updated record after attaching the file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Record'
        '201':
          description: Newly created record derived from uploaded file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Record'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /analyze_file:
    post:
      summary: Analyze a file without storing it to infer type, summary, and properties
      operationId: analyzeFile
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: File to analyze
              required: [file]
      responses:
        '200':
          description: Analysis result describing the inferred record type and metadata
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AnalyzeFileResponse' }
        '400':
          description: Missing file or invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '500':
          description: Analysis service failure
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Record not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /get_file_url:
    get:
      summary: Get signed file URL
      description: Provide a storage path like "files/<record_id>/<filename>".
      operationId: getFileUrl
      parameters:
        - in: query
          name: file_path
          required: true
          schema: { type: string }
        - in: query
          name: expires_in
          required: false
          schema: { type: integer }
      responses:
        '200':
          description: Signed URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileUrlResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /chat:
    post:
      summary: Chat with AI assistant that can query records
      description: |
        Conversational interface that uses OpenAI function calling to intelligently query records from the Neotoma database.
        The assistant will automatically use the retrieve_records function when the user asks about stored data.
      operationId: chat
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ChatRequest' }
            example:
              messages:
                - role: user
                  content: "Show me all my transactions"
      responses:
        '200':
          description: Assistant response with optional records
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ChatResponse' }
        '400':
          description: Invalid payload or OPENAI_API_KEY not configured
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream OpenAI API error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
  /import/plaid/link_token:
    post:
      summary: Create Plaid Link token
      operationId: plaidCreateLinkToken
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlaidLinkTokenRequest' }
      responses:
        '200':
          description: Plaid link token response
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidLinkTokenResponse' }
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream Plaid error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidErrorResponse' }
  /import/plaid/exchange_public_token:
    post:
      summary: Exchange Plaid public token and persist item
      operationId: plaidExchangePublicToken
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlaidExchangePublicTokenRequest' }
      responses:
        '200':
          description: Stored Plaid item metadata
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidExchangePublicTokenResponse' }
        '400':
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream Plaid error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidErrorResponse' }
  /import/plaid/sync:
    post:
      summary: Trigger Plaid sync
      operationId: plaidSync
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlaidSyncRequest' }
      responses:
        '200':
          description: Sync result per Plaid item
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidSyncResponse' }
        '400':
          description: Invalid payload or combination of parameters
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Plaid item not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream Plaid error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidErrorResponse' }
  /import/plaid/items:
    get:
      summary: List stored Plaid items
      operationId: plaidListItems
      parameters:
        - in: query
          name: plaid_item_id
          required: false
          schema: { type: string, format: uuid }
        - in: query
          name: item_id
          required: false
          schema: { type: string }
      responses:
        '200':
          description: Stored Plaid items (metadata only)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidItemsResponse' }
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Plaid item not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream Plaid error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidErrorResponse' }
  /import/plaid/preview_sync:
    post:
      summary: Preview upcoming Plaid sync changes without persisting results
      operationId: plaidPreviewSync
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlaidPreviewSyncRequest' }
      responses:
        '200':
          description: Preview summary for each Plaid item inspected
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidPreviewSyncResponse' }
        '400':
          description: Invalid payload or missing identifier
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Plaid item not found when requested by ID
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream Plaid error during preview
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidErrorResponse' }
  /import/plaid/link_demo:
    get:
      summary: Serve Plaid Link sandbox demo page
      description: Returns an HTML page that initializes Plaid Link with a freshly-minted sandbox link token.
      operationId: plaidLinkDemo
      security: []
      responses:
        '200':
          description: Plaid Link demo page
          content:
            text/html:
              schema:
                type: string
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '500':
          description: Server configuration error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '502':
          description: Upstream Plaid error while creating link token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlaidErrorResponse' }




