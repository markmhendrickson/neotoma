#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Type check (MANDATORY - catches type errors before tests)
echo "Running type check..."
npm run type-check || exit 1

# Lint check (MANDATORY - catches code style issues)
echo "Running linter..."
npm run lint || exit 1

if [ "$SKIP_TESTS" = "1" ] || [ "$NEOTOMA_SKIP_TESTS" = "1" ]; then
  echo "Skipping tests (SKIP_TESTS=1 or NEOTOMA_SKIP_TESTS=1)"
else
  # Unit tests (MANDATORY - catches logic errors)
  echo "Running unit tests..."
  npm test || exit 1

  # Integration tests (if backend/DB files changed)
  if git diff --cached --name-only | grep -E "(src/|tests/integration|supabase/migrations)" > /dev/null; then
    echo "Running integration tests..."
    npm run test:integration || exit 1
  fi

  # E2E tests (if frontend/UI files changed)
  if git diff --cached --name-only | grep -E "(frontend/|playwright/)" > /dev/null; then
    echo "Running E2E tests..."
    npm run test:e2e || exit 1
  fi

  # Validate Playwright coverage map
  npm run validate:coverage

  # Check Playwright test coverage for UI changes
  npm run check:pw-coverage
fi

# Validate documentation dependencies for modified docs
npm run validate:doc-deps

# Apply migrations automatically if migration files changed
if git diff --cached --name-only | grep -E "supabase/migrations/.*\.sql$" > /dev/null; then
  echo "Applying database migrations..."
  npm run migrate || {
    echo "‚ùå Migration failed - fix errors before committing"
    exit 1
  }
fi

# Check Supabase advisor issues (migrations only)
# Block commits if RLS errors are found - these are security issues
npm run check:advisors

# Sync .cursor/ and .claude/ if rule/command sources modified
./scripts/linters/sync_agent_instructions_pre_commit.sh
