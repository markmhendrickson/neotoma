---
# ‚ö†Ô∏è  DO NOT EDIT THIS FILE DIRECTLY
#
# This is a copy of: foundation/agent_instructions/cursor_rules/security.mdc
# Source of truth: foundation/agent_instructions/cursor_rules/security.mdc
#
# To edit this rule:
# 1. Edit the source file in foundation: foundation/agent_instructions/cursor_rules/security.mdc
# 2. Run '/setup_cursor_copies' to sync changes
#
# This file will be overwritten when running setup_cursor_copies.
---

---
description: "Prevents accidental commits of private, sensitive, or confidential documentation and data."
alwaysApply: true
---
# Security Rule

Prevents accidental commits of private, sensitive, or confidential documentation and data.

Configuration: This rule uses protected paths configured in `foundation-config.yaml` under `security.pre_commit_audit.protected_paths`.

## Pre-Commit Security Audit

Before staging or committing ANY changes, perform the following checks:

### 1. Protected Paths Check

Check for any files in protected paths (configured in `foundation-config.yaml`):

```bash
# Load protected paths from config (example paths shown)
PROTECTED_PATHS=("docs/private/" "data/")  # Configured per repository

# Check unstaged changes
for path in "${PROTECTED_PATHS[@]}"; do
  if git status --porcelain | grep -E "^[AM]|^\?\?" | grep -qE "$path"; then
    echo "‚ùå SECURITY VIOLATION: Files in $path detected!"
    git status --porcelain | grep -E "^[AM]|^\?\?" | grep "$path"
    exit 1
  fi
done

# Check staged changes (if any exist)
for path in "${PROTECTED_PATHS[@]}"; do
  if git diff --cached --name-only 2>/dev/null | grep -qE "$path"; then
    echo "‚ùå SECURITY VIOLATION: Files in $path already staged!"
    git diff --cached --name-only | grep "$path"
    exit 1
  fi
done
```

If any files match protected paths, ABORT the commit immediately and alert the user.

### 2. Environment Files Check

Check for any `.env*` files (should be in `.gitignore` but verify):

```bash
if git status --porcelain | grep -qE "\.env"; then
  echo "‚ùå SECURITY VIOLATION: .env files detected!"
  git status --porcelain | grep "\.env"
  exit 1
fi

if git diff --cached --name-only 2>/dev/null | grep -qE "\.env"; then
  echo "‚ùå SECURITY VIOLATION: .env files already staged!"
  git diff --cached --name-only | grep "\.env"
  exit 1
fi
```

If any `.env*` files are detected, ABORT the commit.

Configuration: Enable/disable via `security.pre_commit_audit.check_env_files` in `foundation-config.yaml`.

### 3. Sensitive File Pattern Check

Check for files with sensitive naming patterns:

```bash
# Check for files with "secret" or "private" in path (excluding legitimate code)
git status --porcelain | grep -vE "(test|spec|property_keys)" | grep -iE "(secret|private)" | grep -vE "$(IFS='|'; echo "${PROTECTED_PATHS[*]}")" && echo "WARNING: Suspicious file patterns detected" && exit 1
```

**Note**: This check excludes test files and legitimate code files. Protected paths are also excluded.

### 4. Data Directory Check

Check for files in `data/` directory (should be in `.gitignore`):

```bash
if git status --porcelain | grep -E "^[AM]|^\?\?" | grep -qE "^data/"; then
  echo "‚ùå SECURITY VIOLATION: Files in data/ directory detected!"
  git status --porcelain | grep -E "^[AM]|^\?\?" | grep "^data/"
  exit 1
fi

if git diff --cached --name-only 2>/dev/null | grep -qE "^data/"; then
  echo "‚ùå SECURITY VIOLATION: Files in data/ directory already staged!"
  git diff --cached --name-only | grep "^data/"
  exit 1
fi
```

**Configuration**: Enable/disable via `security.pre_commit_audit.check_data_directory` in `foundation-config.yaml`.

### 5. Hardcoded Credentials Scan

Scan staged and unstaged files for common credential patterns:

```bash
# Only scan text files, exclude binary files
git diff --cached --name-only | xargs -I {} sh -c 'file {} | grep -q "text" && grep -lE "(api[_-]?key|password|secret|token)\s*[:=]\s*['\''\"][^'\''\"]{10,}" {}' && echo "WARNING: Potential hardcoded credentials detected" && exit 1
```

If potential credentials are found, review manually before proceeding.

## Security Audit Execution

The security audit must be executed BEFORE running `git add -A` or staging any files.

### Audit Script

The audit script should load protected paths from `foundation-config.yaml`:

```bash
#!/bin/bash
set -e

echo "üîí Running pre-commit security audit..."

# Load protected paths from foundation-config.yaml
# (Implementation depends on YAML parsing - use yq, python, or node)
PROTECTED_PATHS=($(yq eval '.security.pre_commit_audit.protected_paths[]' foundation-config.yaml 2>/dev/null || echo ""))

# Check 1: Protected paths
for path in "${PROTECTED_PATHS[@]}"; do
  if git status --porcelain | grep -E "^[AM]|^\?\?" | grep -qE "$path"; then
    echo "‚ùå SECURITY VIOLATION: Files in $path detected!"
    echo "Files:"
    git status --porcelain | grep -E "^[AM]|^\?\?" | grep "$path"
    exit 1
  fi

  if git diff --cached --name-only 2>/dev/null | grep -qE "$path"; then
    echo "‚ùå SECURITY VIOLATION: Files in $path already staged!"
    echo "Files:"
    git diff --cached --name-only | grep "$path"
    exit 1
  fi
done

# Check 2: Environment files (if enabled)
if yq eval '.security.pre_commit_audit.check_env_files' foundation-config.yaml 2>/dev/null | grep -q "true"; then
  if git status --porcelain | grep -qE "\.env"; then
    echo "‚ùå SECURITY VIOLATION: .env files detected!"
    git status --porcelain | grep "\.env"
    exit 1
  fi

  if git diff --cached --name-only 2>/dev/null | grep -qE "\.env"; then
    echo "‚ùå SECURITY VIOLATION: .env files already staged!"
    git diff --cached --name-only | grep "\.env"
    exit 1
  fi
fi

# Check 3: Data directory (if enabled)
if yq eval '.security.pre_commit_audit.check_data_directory' foundation-config.yaml 2>/dev/null | grep -q "true"; then
  if git status --porcelain | grep -E "^[AM]|^\?\?" | grep -qE "^data/"; then
    echo "‚ùå SECURITY VIOLATION: Files in data/ directory detected!"
    git status --porcelain | grep -E "^[AM]|^\?\?" | grep "^data/"
    exit 1
  fi

  if git diff --cached --name-only 2>/dev/null | grep -qE "^data/"; then
    echo "‚ùå SECURITY VIOLATION: Files in data/ directory already staged!"
    git diff --cached --name-only | grep "^data/"
    exit 1
  fi
fi

echo "‚úÖ Security audit passed"
```

## Enforcement

This security audit must be run:
1. Before any `git add` command
2. Before any `git commit` command
3. As part of the commit command workflow

## Failure Behavior

If the security audit fails:
1. STOP all git operations immediately
2. Do NOT stage or commit any files
3. Display clear error message to user
4. List the specific files that triggered the violation
5. Wait for user to resolve the issue before proceeding

## Configuration

Configure protected paths and audit checks in `foundation-config.yaml`:

```yaml
security:
  pre_commit_audit:
    protected_paths:
      - "docs/private/"  # Example: repository-specific protected paths
      - "data/"          # Example: data directory
    check_env_files: true
    check_data_directory: true
```

## Exceptions

No exceptions. Private documentation must never be committed to public repositories.









