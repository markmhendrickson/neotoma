---
description: "Load when committing, configuring pre-commit, or adding protected paths: security audit blocks commits of protected_paths, .env*, data/; gitleaks scans for credentials; do not bypass hooks."
alwaysApply: false
---

# ‚ö†Ô∏è  DO NOT EDIT THIS FILE DIRECTLY
#
# This is a copy of: foundation/agent_instructions/cursor_rules/security.mdc
# Source of truth: foundation/agent_instructions/cursor_rules/security.mdc
#
# To edit this rule:
# 1. Edit the source file: foundation/agent_instructions/cursor_rules/security.mdc
# 2. Run '/setup_cursor_copies' to sync changes
#
# This file will be overwritten when running setup_cursor_copies.

# Security Rule

Prevents accidental commits of private, sensitive, or confidential documentation and data.

Configuration: This rule uses protected paths configured in `foundation-config.yaml` under `security.pre_commit_audit.protected_paths`.

## Pre-Commit Security Audit

**Implementation:** The security audit is enforced by `scripts/linters/security_audit.py` and configured in `.pre-commit-config.yaml` under the `security-audit` hook.

**Configuration:** All settings are in `foundation-config.yaml` under `security.pre_commit_audit`:
- `protected_paths` ‚Äî paths that must never be committed
- `check_env_files` ‚Äî enable/disable .env file checking
- `check_data_directory` ‚Äî enable/disable data/ directory checking
- Secrets detection is handled by gitleaks (separate hook)

### Checks Performed

The pre-commit hook (`scripts/linters/security_audit.py`) performs:

1. **Protected Paths Check** ‚Äî Checks staged and unstaged files against configured `protected_paths`
2. **Environment Files Check** ‚Äî Detects `.env*` files (if `check_env_files: true`)
3. **Data Directory Check** ‚Äî Detects files in `data/` or `$DATA_DIR/` (if `check_data_directory: true`)

**Gitleaks** (separate hook in `.pre-commit-config.yaml`) handles:

4. **Hardcoded Credentials Scan** ‚Äî Scans for API keys, passwords, secrets, tokens in staged files

### Security Audit Execution

The security audit runs automatically before every commit via pre-commit hooks:

```bash
# Runs automatically on commit
git commit -m "message"

# Or manually via pre-commit
pre-commit run security-audit --all-files
pre-commit run gitleaks --all-files

```bash
#!/bin/bash
set -e

echo "üîí Running pre-commit security audit..."

# Load protected paths from foundation-config.yaml
# (Implementation depends on YAML parsing - use yq, python, or node)
PROTECTED_PATHS=($(yq eval '.security.pre_commit_audit.protected_paths[]' foundation-config.yaml 2>/dev/null || echo ""))

# Check 1: Protected paths
for path in "${PROTECTED_PATHS[@]}"; do
  if git status --porcelain | grep -E "^[AM]|^\?\?" | grep -qE "$path"; then
    echo "‚ùå SECURITY VIOLATION: Files in $path detected!"
    echo "Files:"
    git status --porcelain | grep -E "^[AM]|^\?\?" | grep "$path"
    exit 1
  fi

  if git diff --cached --name-only 2>/dev/null | grep -qE "$path"; then
    echo "‚ùå SECURITY VIOLATION: Files in $path already staged!"
    echo "Files:"
    git diff --cached --name-only | grep "$path"
    exit 1
  fi
done

# Check 2: Environment files (if enabled)
if yq eval '.security.pre_commit_audit.check_env_files' foundation-config.yaml 2>/dev/null | grep -q "true"; then
  if git status --porcelain | grep -qE "\.env"; then
    echo "‚ùå SECURITY VIOLATION: .env files detected!"
    git status --porcelain | grep "\.env"
    exit 1
  fi

  if git diff --cached --name-only 2>/dev/null | grep -qE "\.env"; then
    echo "‚ùå SECURITY VIOLATION: .env files already staged!"
    git diff --cached --name-only | grep "\.env"
    exit 1
  fi
fi

# Check 3: Data directory (if enabled)
if yq eval '.security.pre_commit_audit.check_data_directory' foundation-config.yaml 2>/dev/null | grep -q "true"; then
  if git status --porcelain | grep -E "^[AM]|^\?\?" | grep -qE "^data/"; then
    echo "‚ùå SECURITY VIOLATION: Files in data/ directory detected!"
    git status --porcelain | grep -E "^[AM]|^\?\?" | grep "^data/"
    exit 1
  fi

  if git diff --cached --name-only 2>/dev/null | grep -qE "^data/"; then
    echo "‚ùå SECURITY VIOLATION: Files in data/ directory already staged!"
    git diff --cached --name-only | grep "^data/"
    exit 1
  fi
fi

echo "‚úÖ Security audit passed"
```

### Agent Responsibilities

Agents MUST NOT:
- Bypass or skip the pre-commit security audit
- Commit files in protected paths
- Suggest workarounds to security checks
- Use `--no-verify` flag to skip hooks

Agents SHOULD:
- Respect the pre-commit hook enforcement
- Alert user if security violations are detected during normal operations
- Recommend fixing violations (moving files, updating .gitignore) rather than bypassing checks

## Enforcement

The security audit is enforced automatically by pre-commit hooks:
- Runs on every `git commit`
- Cannot be bypassed without explicit `--no-verify` flag
- Configuration-driven via `foundation-config.yaml`

## Failure Behavior

If the security audit hook fails:
1. Commit is blocked
2. Clear error message displays with violating files
3. User must resolve violations (remove files, update .gitignore, or exclude from commit)
4. Commit again after resolving

## Configuration

All security audit configuration is in `foundation-config.yaml`:

```yaml
security:
  pre_commit_audit:
    enabled: true
    protected_paths:
      - "$DATA_DIR/imports/"
      - "$DATA_DIR/attachments/"
      - "docs/private/"
      - ".env*"
    check_env_files: true
    check_data_directory: true
```

See `foundation-config.yaml` in your repository for the actual configuration.

## Related Files

- `scripts/linters/security_audit.py` ‚Äî Security audit implementation
- `.pre-commit-config.yaml` ‚Äî Hook configuration (security-audit and gitleaks)
- `.gitleaks.toml` ‚Äî Gitleaks configuration for credential scanning









