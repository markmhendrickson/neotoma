---
# ⚠️  DO NOT EDIT THIS FILE DIRECTLY
#
# This is a copy of: docs/developer/pre_release_validation_rules.mdc
# Source of truth: docs/developer/pre_release_validation_rules.mdc
#
# To edit this rule:
# 1. Edit the source file: docs/developer/pre_release_validation_rules.mdc
# 2. Run '/setup_cursor_copies' to sync changes
#
# This file will be overwritten when running setup_cursor_copies.
---

---
description: "Systematic validation checklist to catch critical issues before release deployment, based on past release issues and near-misses"
alwaysApply: true
---
# Pre-Release Validation Checklist

_(Development Process: Quality Assurance)_

---

## Purpose

This checklist ensures critical issues are caught before release deployment. It documents systematic
validation steps based on past release issues and near-misses.

## Scope

This checklist covers:
- Code quality checks before deployment
- Migration validation
- Build and compilation verification
- Service startup verification
- Common failure modes

## When to Use

Run this checklist:
- Before marking a release as `ready_for_deployment`
- After completing all feature units
- Before manual validation/testing phase

## Pre-Release Validation Checklist

### 1. Code Quality

#### 1.1 TypeScript Compilation

- [ ] **Run TypeScript compiler**: `npm run type-check` or `tsc --noEmit`
  - **Why**: Catches type errors, mismatched interfaces, incorrect return types
  - **Past issues**: `resolveEntity` return type mismatch, `FileAnalysisResult` interface mismatch

- [ ] **Fix all compilation errors** before proceeding

- [ ] **Review type changes** for breaking changes in service interfaces

#### 1.2 Linting

- [ ] **Run linter**: `npm run lint`
  - **Why**: Catches code style issues, unused variables, potential bugs

- [ ] **Fix all linter errors** (warnings are acceptable but should be reviewed)

#### 1.3 Code Consistency

- [ ] **Check for quote consistency** across modified files
  - **Why**: Mismatched quotes break compilation
  - **Past issues**: Mixed single/double quotes in multiple files

- [ ] **Verify import statements** are correct and consistent

- [ ] **Check for hardcoded values** that should be environment variables

### 2. Database Migrations

#### 2.1 Migration Completeness

- [ ] **All tables in `schema.sql` have migrations**:
  ```bash
  # List tables in schema.sql
  grep "^CREATE TABLE" supabase/schema.sql
  
  # List tables in migrations
  grep "^CREATE TABLE" supabase/migrations/*.sql
  
  # Compare - every table should appear in both
  ```
  - **Why**: Tables without migrations won't exist after fresh deployment
  - **Past issues**: `record_relationships`, `records`, `plaid_items`, `plaid_sync_runs`,
    `external_connectors`, `external_sync_runs` missing from migrations

- [ ] **All ALTER TABLE statements** in `schema.sql` have corresponding migrations

- [ ] **All indexes** from `schema.sql` are in migrations

- [ ] **All RLS policies** from `schema.sql` are in migrations

#### 2.2 Migration Validation

- [ ] **Run migrations in clean environment**: 
  ```bash
  npm run migrate
  ```
  - **Why**: Ensures migrations work on fresh database
  - **Test on**: Staging database or local Supabase instance

- [ ] **Check for migration errors**:
  - Extension dependencies (e.g., `vector` extension must be in correct schema)
  - Column dependencies (e.g., foreign keys to columns that don't exist yet)
  - Index dependencies (e.g., indexes on columns added in same migration)

- [ ] **Verify migration order**: Migrations should be numbered sequentially

- [ ] **Test migration rollback** if applicable

#### 2.3 Schema Consistency

- [ ] **Run schema advisor**: 
  ```bash
  npm run check:advisors
  ```
  - **Why**: Detects RLS issues, missing indexes, security problems
  - **Past issues**: Tables with policies but RLS not enabled

- [ ] **Verify RLS enabled** on all user-facing tables

- [ ] **Check for missing indexes** on foreign keys

- [ ] **Validate policy coverage** for all operations

### 3. Service Startup

#### 3.1 Build Verification

- [ ] **Clean build**: 
  ```bash
  rm -rf dist/
  npm run build
  ```
  - **Why**: Ensures build artifacts are up to date
  - **Check**: No build errors, `dist/` directory created

- [ ] **Watch mode works**: 
  ```bash
  npm run dev:mcp
  ```
  - **Why**: Ensures development workflow isn't broken
  - **Check**: TypeScript compiles without errors

#### 3.2 MCP Server Startup

- [ ] **Start MCP server locally**:
  ```bash
  npm run dev
  ```
  - **Why**: Catches initialization errors, missing dependencies, logging issues
  - **Past issues**: Logging to stdout breaks JSON-RPC protocol

- [ ] **Verify no stdout pollution**:
  - **Check**: No console.log/error to stdout in MCP mode
  - **Check**: All logging uses `logger` utility with MCP suppression
  - **Past issues**: MCP JSON-RPC protocol broken by console output

- [ ] **Check database connection**:
  - **Verify**: All required tables exist
  - **Verify**: RLS policies work correctly
  - **Past issues**: `record_relationships` table not found

#### 3.3 MCP Integration

- [ ] **Test MCP connection with Cursor**:
  - Update `.cursor/mcp.json` with correct paths
  - Restart Cursor
  - Verify MCP server appears in tools list
  - Test a simple MCP call (e.g., `retrieve_records`)

- [ ] **Check MCP configuration**:
  - **Verify**: Node path is correct (`which node`)
  - **Verify**: Working directory is correct
  - **Verify**: Environment variables are loaded
  - **Past issues**: Wrong node version, incorrect cwd

### 4. Test Suite

#### 4.1 Unit Tests

- [ ] **Run all tests**: 
  ```bash
  npm test
  ```
  - **Why**: Catches regressions in core functionality
  - **Target**: 100% pass rate for affected modules

- [ ] **Run integration tests**: 
  ```bash
  npm run test:integration
  ```
  - **Why**: Validates end-to-end flows
  - **Check**: All integration tests pass

#### 4.2 Test Coverage

- [ ] **Check test coverage** for new/modified code:
  ```bash
  npm run test:coverage
  ```
  - **Target**: >80% coverage for critical paths
  - **Review**: Uncovered lines in new code

### 5. Environment Variables

- [ ] **Verify required environment variables**:
  - `DEV_SUPABASE_PROJECT_ID` or `DEV_SUPABASE_URL`
  - `DEV_SUPABASE_SERVICE_KEY`
  - Any new environment variables added in this release

- [ ] **Check `.env.example` is up to date** with new variables

- [ ] **Verify environment-specific configs** (dev vs prod)

### 6. Dependencies

- [ ] **Check for new dependencies**:
  ```bash
  git diff main package.json
  ```

- [ ] **Verify dependencies are installed**:
  ```bash
  npm ci
  ```

- [ ] **Check for security vulnerabilities**:
  ```bash
  npm audit
  ```

### 7. Documentation

- [ ] **README.md updated** with release status change

- [ ] **Release status.md** reflects `ready_for_deployment`

- [ ] **Migration docs updated** if schema changed

- [ ] **API changes documented** if interfaces changed

## Quick Pre-Release Command Sequence

Run these commands in order for a comprehensive check:

```bash
# 1. Clean and install
npm ci

# 2. Type check
npm run type-check

# 3. Lint
npm run lint

# 4. Build
rm -rf dist/ && npm run build

# 5. Run tests
npm test

# 6. Run integration tests  
npm run test:integration

# 7. Check migrations
npm run migrate:dry-run

# 8. Check schema advisors
npm run check:advisors

# 9. Test MCP server startup (in background terminal)
npm run dev

# 10. Test MCP watch mode (in background terminal)
npm run dev:mcp
```

If all commands succeed, the release is ready for manual validation.

## Common Failure Modes

### 1. Compilation Errors

**Symptoms**: `tsc` fails, type errors  

**Root causes**: 
- Interface changes without updating call sites
- Return type mismatches
- Missing type definitions

**Prevention**: Run `npm run type-check` before committing

### 2. Missing Migrations

**Symptoms**: "Table not found" errors on fresh deployment  

**Root causes**:
- Tables added to `schema.sql` but not to migrations
- Migrations not numbered or named correctly

**Prevention**: Compare `schema.sql` with migrations directory

### 3. MCP Protocol Errors

**Symptoms**: "Unexpected token" JSON parsing errors in MCP logs  

**Root causes**:
- Console output to stdout in MCP mode
- Logging not using `logger` utility

**Prevention**: Search for `console.log/error/warn` in MCP-related files

### 4. RLS Issues

**Symptoms**: Security advisor warnings, policy violations  

**Root causes**:
- Tables without RLS enabled
- Policies not covering all operations
- Conditional SQL in migrations

**Prevention**: Run `npm run check:advisors` after schema changes

### 5. Extension Issues

**Symptoms**: "type does not exist" errors in migrations  

**Root causes**:
- Extensions not installed
- Extensions in wrong schema
- Search path not set correctly

**Prevention**: Ensure extensions are created before use, with correct schema

## Post-Validation Actions

After all checks pass:

1. **Update release status** to `ready_for_deployment`
2. **Update README.md** with release status
3. **Commit validation results** to release documentation
4. **Proceed to manual testing phase** (see `integration_tests.md`)

## References

- **Release process**: `docs/developer/release_orchestrator.md`
- **Integration tests**: `docs/releases/{version}/integration_tests.md`
- **Deployment strategy**: `docs/releases/{version}/deployment_strategy.md`
- **Migration guide**: `supabase/migrations/README.md`

---

## Maintenance

This checklist should be updated when:
- New types of pre-release issues are discovered
- New validation tools are added
- Release process changes significantly

**Last updated**: 2025-12-31  
**Based on issues from**: v0.2.0 release

