---
description: "Automatically detects bug fix intent from user patterns and triggers the bug fix workflow"
globs: ["**/*"]
alwaysApply: true
---

# ⚠️  DO NOT EDIT THIS FILE DIRECTLY
#
# This is a copy of: foundation/agent_instructions/cursor_rules/bug_fix_detection.mdc
# Source of truth: foundation/agent_instructions/cursor_rules/bug_fix_detection.mdc
#
# To edit this rule:
# 1. Edit the source file: foundation/agent_instructions/cursor_rules/bug_fix_detection.mdc
# 2. Run '/setup_cursor_copies' to sync changes
#
# This file will be overwritten when running setup_cursor_copies.

# Bug Fix Detection Rule

**Reference:** `foundation/agent_instructions/cursor_commands/fix_feature_bug.md` — Bug fix workflow (or `.cursor/commands/foundation_fix_feature_bug.md` if symlinked)

Configuration is read from `foundation-config.yaml`.

## Trigger Patterns

When a user mentions any of the following patterns, automatically detect bug fix intent:

- "bug"
- "error"
- "fix"
- "broken"
- "not working"
- "failing"
- "issue" (in context of problems)
- "problem" (in context of code/functionality)
- Error messages or stack traces
- Test failures
- "regression"
- "broken feature"
- "doesn't work"

## Agent Actions

### Step 1: Detection and Confirmation

If context suggests a bug (mentions "bug", "error", "fix", "broken", error messages, etc.):

1. **Extract bug information** from context:
   - Error messages or stack traces (if provided)
   - Feature/module ID (if mentioned or can be inferred from path/context)
   - Description of the problem
   - Steps to reproduce (if mentioned)

2. **Identify affected feature/module:**
   - Check error messages for file paths
   - Check context for feature mentions
   - Check open files for feature references
   - If cannot identify → ask user: "Which feature/module is affected? (identifier or 'unknown')"

3. **Ask for confirmation:**
   ```
   I see you're reporting a bug. Should I fix this using the bug fix workflow? 
   Feature/Module: {identifier} (or 'unknown' if not identified)
   (yes/no)
   ```

4. **Exception handling:**
   - If user says "no" → do not proceed with bug fix workflow
   - If user says "just document it" → document the bug instead

### Step 2: Execute Bug Fix Workflow

**If user confirms (yes):**

1. **Load configuration:**
   - Read `foundation-config.yaml` to get bug fix workflow settings
   - Check if error classification is configured
   - Determine feature unit directory (if feature units enabled)

2. **Load required documents:**
   - `foundation/agent_instructions/cursor_commands/fix_feature_bug.md` (command implementation, or `.cursor/commands/foundation_fix_feature_bug.md` if symlinked)
   - Repository navigation guide (if configured)
   - Feature spec and manifest (if feature units enabled and identifier provided)
   - Error classification documentation (if configured)
   - Relevant subsystem/module docs (if configured)

3. **Follow the bug fix workflow:**
   - Identify feature/module from error, path, or context
   - Load spec and manifest (if available)
   - Classify bug using configured error classification (if available)
   - Apply correction rules based on classification
   - Always add a regression test
   - Run tests

4. **Output:**
   - Error class (if classification configured)
   - Reason for classification
   - Corrected files
   - Tests added/updated

## Error Classification (Configurable)

If error classification is configured in `foundation-config.yaml`, classify bugs into configured classes. Example classification:

- **Class 1:** Implementation bug, spec is correct, code doesn't match spec
- **Class 2:** Spec bug, spec is incomplete or wrong, code matches spec but spec is wrong
- **Class 3:** Architectural bug, subsystem/architecture docs are wrong or incomplete

**Correction rules (if classification configured):**
- Class 1: Patch code only
- Class 2: Update spec/manifest first, then align code/tests
- Class 3: Update architecture docs first, then rebuild

## Constraints

- Do NOT proceed without user confirmation - always ask before fixing bugs
- Always classify error if classification is configured
- Always add regression test - never fix without test
- Always run tests after fix
- Always update spec/manifest for Class 2 bugs (if classification configured)
- Always update architecture docs for Class 3 bugs (if classification configured)

## Integration with Commands

This rule complements the explicit `/fix_feature_bug` command:
- **Rule-based detection:** Triggers automatically when bug patterns are detected
- **Explicit command:** User can call `/fix_feature_bug` directly

Both paths lead to the same workflow execution.

## Configuration

Bug fix detection uses settings from `foundation-config.yaml`:

```yaml
development:
  bug_fix:
    enabled: true
    error_classification:
      enabled: false  # Enable if you have error classification system
      classes:
        - name: "Class 1"
          description: "Implementation bug"
          correction: "Patch code only"
        - name: "Class 2"
          description: "Spec bug"
          correction: "Update spec first, then code"
        - name: "Class 3"
          description: "Architectural bug"
          correction: "Update architecture docs first"
    require_regression_test: true
    test_commands:  # Optional, repo-specific test commands
      - "npm test"
      - "npm run test:integration"
```
