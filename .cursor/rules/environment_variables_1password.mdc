# Environment Variables from 1Password Rule

**Reference:** `foundation/agent_instructions/cursor_rules/configuration_management.md` - Configuration management

## Purpose

Ensures agents always fetch environment variables from 1Password when needed, rather than asking users or using placeholders. This applies to all environment variables that exist in 1Password, including credentials, API keys, and configuration values.

## Trigger Patterns

When any of the following occur, agents MUST fetch environment variables from 1Password:

- **Scripts or code require environment variables** that are stored in 1Password
- **Configuration needs credentials** (API keys, tokens, passwords, etc.)
- **Setting up integrations** that require authentication (SendGrid, AWS, etc.)
- **Deploying or configuring services** that need secrets
- **User explicitly requests** environment variable setup
- **Environment variables are missing from .env** after sync (check if mapping exists, add if needed)

## Agent Actions

### Step 1: Identify Required Environment Variables

When code or scripts need environment variables:

1. **Identify what's needed:**
   - Check script/code for environment variable references
   - Identify which variables are required
   - Determine if they exist in 1Password

2. **Check if mappings exist:**
   - Query `env_var_mappings` parquet to see if variables are mapped
   - If not mapped but exist in 1Password, **proactively add mappings** (see Step 1a)

### Step 1a: Add Missing Mappings (Proactive)

**If a required variable exists in 1Password but is not in mappings:**

1. **Add mapping to env_var_mappings parquet:**
   - Use MCP parquet `add_record` to add the mapping
   - Include: `env_var`, `op_reference`, `vault`, `item_name`, `service`, `is_optional`
   - Format: `op://{vault}/{item_name}/{field_label}`

2. **Example:**
   ```javascript
   // Add SENDGRID_API_KEY mapping
   {
     "data_type": "env_var_mappings",
     "record": {
       "env_var": "SENDGRID_API_KEY",
       "op_reference": "op://Private/Sendgrid/API key",
       "vault": "Private",
       "item_name": "Sendgrid",
       "service": "SendGrid",
       "is_optional": false
     }
   }
   ```

3. **After adding mappings, run sync command:**
   - Run `/sync_env_from_1password` to load new variables into `.env`

### Step 2: Load Environment Variables into .env

**MANDATORY: Use sync command to load variables into .env first:**

1. **Run sync command** (preferred method):
   ```bash
   /sync_env_from_1password
   ```
   Or via npm:
   ```bash
   npm run sync:env
   ```
   Or directly:
   ```bash
   export ENVIRONMENT=development  # or production (defaults to development)
   python3 foundation/scripts/op_sync_env_from_1password.py
   ```
   - This syncs all mapped variables from 1Password to `.env`
   - Handles environment-based keys automatically
   - Preserves unmanaged variables
   - Creates backup before modification

2. **Verify variables are in .env:**
   ```bash
   grep "^VARIABLE_NAME=" .env
   ```

**For variables not in mappings:**

1. **Add to env_var_mappings first** (if it's a recurring need):
   - Use MCP parquet `add_record` to add mapping
   - Then run sync command to load into `.env`

2. **If one-time use only:**
   - Manually fetch from 1Password and add to `.env`
   - Or add to mappings for future syncs

### Step 3: Use in Scripts/Code

**In scripts:**
- **MUST NOT directly integrate with 1Password** - scripts should only read from `.env`
- **MUST assume variables are already in `.env`** (loaded via sync command)
- **MUST NOT fetch from 1Password at runtime** - use sync command first
- **MUST NOT ask users for credentials** - direct them to run sync command instead
- Read values from `.env` file or environment variables

**In code:**
- Read from environment variables (loaded from `.env` after sync)
- Never prompt users for credentials that exist in 1Password
- Never directly call 1Password CLI from application code

## Examples

### ✅ Correct: Load Variables via Sync Command, Then Use in Script

```bash
# Step 1: Load variables into .env via sync command
/sync_env_from_1password
# or: npm run sync:env

# Step 2: Script reads from .env (no 1Password integration)
if [ -f .env ]; then
  source .env  # or use grep to extract specific variables
  SENDGRID_SENDER_EMAIL="${SENDGRID_SENDER_EMAIL}"
fi
```

### ✅ Correct: Script Assumes Variables in .env

```bash
#!/bin/bash
# Script reads from .env (variables loaded via sync command)
if [ -f .env ]; then
  SUPABASE_PROJECT_ID=$(grep "^SUPABASE_PROJECT_ID=" .env | cut -d '=' -f2- | sed 's/^"//;s/"$//' | tr -d '\n')
  SENDGRID_API_KEY=$(grep "^SENDGRID_API_KEY=" .env | cut -d '=' -f2- | sed 's/^"//;s/"$//' | tr -d '\n')
fi
```

### ✅ Correct: Agent Runs Sync Command First

```bash
# Agent action: Run sync command before executing script
/sync_env_from_1password

# Then run script that uses variables
./scripts/my_script.sh  # Script reads from .env
```

### ❌ Incorrect: Direct 1Password Integration in Scripts

```bash
# WRONG - Script should not directly fetch from 1Password
SENDGRID_API_KEY=$(op item get "Sendgrid" --vault Private --fields "API key" --format json | python3 -c "...")
```

### ❌ Incorrect: Ask User for Credentials

```bash
# WRONG - Don't ask user for values that exist in 1Password
read -p "Enter SendGrid API key: " API_KEY
# Instead: Direct user to run /sync_env_from_1password
```

### ❌ Incorrect: Use Placeholder Values

```bash
# WRONG - Don't use placeholders when values exist in 1Password
SENDGRID_SENDER_EMAIL="your-email@example.com"  # Should be in .env after sync
```

### ❌ Incorrect: Skip Sync Command

```bash
# WRONG - Don't skip sync command and try to fetch directly
if [ -z "$API_KEY" ]; then
  op item get "..."  # Should run /sync_env_from_1password first
fi
```

## Integration with Sync Command

**The `/sync_env_from_1password` command** (or `sync_env_from_1password` cursor command) **MUST be run:**

1. **Before running ANY script** that needs environment variables from 1Password
2. **After updating 1Password** with new credentials
3. **When setting up** a new environment
4. **When switching** between development/production
5. **When variables are missing** from `.env`

**The sync command:**
- Reads mappings from `env_var_mappings` parquet (via MCP)
- Fetches values from 1Password using `op` CLI
- Updates `.env` file with resolved values
- Preserves unmanaged variables
- Handles environment-based keys (development/production)
- Creates backup before modification

**Scripts MUST NOT:**
- Directly call 1Password CLI (`op` commands)
- Fetch credentials at runtime from 1Password
- Integrate 1Password authentication logic
- Ask users to provide credentials manually

**Scripts MUST:**
- Read from `.env` file only
- Assume variables are already loaded via sync command
- Provide clear error if variable missing (direct user to run sync command)

## Constraints

- **MUST use sync command** (`/sync_env_from_1password`) to load variables into `.env` first
- **MUST NOT integrate 1Password directly** into scripts - scripts read from `.env` only
- **MUST NOT ask users** for credentials that are in 1Password - direct them to run sync command
- **MUST NOT use placeholders** when real values are available in 1Password
- **MUST NOT fetch from 1Password at runtime** - use sync command before running scripts
- **MUST add to mappings** if variable will be needed repeatedly (then sync will include it)
- **MUST assume variables are in `.env`** - scripts should read from `.env`, not 1Password

## When Variables Are Missing

**If variable is not in `.env` after sync:**

1. **Run sync command first:**
   ```bash
   /sync_env_from_1password
   ```

2. **If still missing:**
   - Check if variable is in `env_var_mappings` parquet
   - If not, add mapping first, then re-run sync
   - If mapping exists, verify 1Password item/field exists

3. **If 1Password CLI is not authenticated:**
   - Prompt user to authenticate: `eval $(op signin)`
   - Then re-run sync command

**If variable doesn't exist in 1Password:**

1. **Add it to 1Password** first (if it's a credential/secret)
2. **Add to env_var_mappings** if it will be needed regularly
3. **Run sync command** to load into `.env`

**Scripts should handle missing variables gracefully:**

```bash
if [ -z "$REQUIRED_VAR" ]; then
  echo "❌ REQUIRED_VAR not found in .env"
  echo "   Run: /sync_env_from_1password"
  echo "   Or: npm run sync:env"
  exit 1
fi
```

## Related Documents

- `foundation/scripts/op_sync_env_from_1password.py` - Environment sync script
- `foundation/agent_instructions/cursor_commands/sync_env_from_1password.md` - Sync command documentation
- `foundation/agent_instructions/cursor_rules/configuration_management.md` - Configuration management

## Agent Instructions

### When to Load This Document

Load this document when:
- Writing scripts that need environment variables
- Configuring services that require credentials
- Setting up integrations
- User requests environment variable setup

### Required Co-Loaded Documents

- `foundation/agent_instructions/cursor_rules/configuration_management.md` - Configuration management
- `foundation/agent_instructions/cursor_commands/sync_env_from_1password.md` - Sync command reference

### Constraints Agents Must Enforce

1. **Always run sync command first** (`/sync_env_from_1password`) to load variables into `.env`
2. **Never integrate 1Password directly** into scripts - scripts read from `.env` only
3. **Never ask users for credentials** - direct them to run sync command instead
4. **Never use placeholder values** when real values are available in 1Password
5. **Never fetch from 1Password at runtime** - use sync command before running scripts
6. **Add to env_var_mappings** if variable will be needed repeatedly (then sync will include it)
7. **Scripts assume variables are in `.env`** - provide clear errors if missing, directing to sync command

### Forbidden Patterns

- **Integrating 1Password CLI directly into scripts** (`op` commands in scripts)
- **Fetching credentials at runtime from 1Password** (should be in `.env` after sync)
- **Asking users for credentials** that exist in 1Password (direct to sync command instead)
- **Using placeholder values** when real values are available in 1Password
- **Skipping sync command** and trying to fetch directly from 1Password
- **Hardcoding credentials** in scripts or code
- **Assuming users will manually set environment variables** (use sync command)

### Validation Checklist

- [ ] Checked env_var_mappings for required variables (added mappings if missing)
- [ ] Ran sync command (`/sync_env_from_1password`) before executing scripts
- [ ] Verified required variables are in `.env` after sync
- [ ] Scripts read from `.env` only (no direct 1Password integration)
- [ ] No `op` CLI commands in scripts (1Password integration removed)
- [ ] No user prompts for credentials (added mappings and ran sync instead)
- [ ] No placeholder values used when real values are available
- [ ] Added to env_var_mappings if variable will be needed repeatedly
- [ ] Scripts provide clear errors if variables missing (direct to sync command)
- [ ] Ran `/setup_cursor_copies` if foundation rules/commands were updated
