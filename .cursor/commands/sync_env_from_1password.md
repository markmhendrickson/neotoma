<!--
⚠️  DO NOT EDIT THIS FILE DIRECTLY

This is a copy of: foundation/agent_instructions/cursor_commands/sync_env_from_1password.md
Source of truth: foundation/agent_instructions/cursor_commands/sync_env_from_1password.md

To edit this command:
1. Edit the source file in foundation: foundation/agent_instructions/cursor_commands/sync_env_from_1password.md
2. Run '/setup_cursor_copies' to sync changes

This file will be overwritten when running setup_cursor_copies.
-->

# Sync Environment Variables from 1Password

Syncs selected environment variables from 1Password into a local `.env` file.

## Command

```
sync_env_from_1password
```

or

```
sync env from 1password
```

## Purpose

This command executes the 1Password environment sync script, which:

1. Reads environment variable mappings from parquet file via MCP server (or direct parquet read as fallback)
2. Uses 1Password CLI (`op`) to resolve each secret value
3. Updates the `.env` file with resolved values from 1Password
4. Creates a timestamped backup before modification
5. Preserves unmanaged variables (variables not in 1Password mappings)
6. Supports exclusion lists via configuration

**Script Location:**
- `scripts/op_sync_env_from_1password.py` - Wrapper script (delegates to foundation)
- `foundation/scripts/op_sync_env_from_1password.py` - Foundation script (generalized, repository-agnostic)

## When to Use

- After setting up a new repository or environment
- When environment variables need to be refreshed from 1Password
- After updating environment variable mappings in the parquet file
- When switching between environments (development/production)
- When `.env` file is missing or needs to be regenerated

## Execution Instructions

### Step 1: Verify Prerequisites

**Check 1Password CLI authentication:**
- Ensure `op` CLI is installed
- Verify you're signed in: `op whoami` should succeed
- If not authenticated, sign in: `eval $(op signin)` or `op signin`

**Check Python environment:**
- Ensure Python 3.9+ is available
- Verify required packages: `pandas`, `pyarrow` (for fallback), `mcp` (for primary method)
- Install if needed: `pip install pandas pyarrow mcp`

**Check repository structure:**
- Ensure you're in a repository with `foundation-config.yaml` or `.git` directory
- Verify the script exists: `scripts/op_sync_env_from_1password.py` or `foundation/scripts/op_sync_env_from_1password.py`

### Step 2: Determine Script Location

**Find the script path:**
```bash
# Check if foundation is in current repo
if [ -f "scripts/op_sync_env_from_1password.py" ]; then
  SCRIPT_PATH="scripts/op_sync_env_from_1password.py"
elif [ -f "foundation/scripts/op_sync_env_from_1password.py" ]; then
  SCRIPT_PATH="foundation/scripts/op_sync_env_from_1password.py"
elif [ -f "../foundation/scripts/op_sync_env_from_1password.py" ]; then
  SCRIPT_PATH="../foundation/scripts/op_sync_env_from_1password.py"
else
  echo "ERROR: Script not found. Please ensure foundation is installed."
  exit 1
fi
```

### Step 3: Determine Target .env File

**Default behavior:**
- Script defaults to `.env` in repository root
- Can specify custom path as argument

**Check if custom path needed:**
```bash
# Default: .env in repo root
ENV_PATH=""

# Or specify custom path (optional)
# ENV_PATH="path/to/.env.custom"
```

### Step 4: Execute Script

**Run the script:**
```bash
# From repository root
python3 "$SCRIPT_PATH" $ENV_PATH
```

**Or if using custom .env path:**
```bash
python3 "$SCRIPT_PATH" path/to/.env.custom
```

### Step 5: Verify Results

**Check output:**
- Script should report repository root
- Should verify 1Password session
- Should create backup (if .env exists)
- Should list variables being resolved
- Should report success with updated variable names

**Expected output:**
```
Repository root: /path/to/repo

Checking 1Password session...
✓ 1Password session active

Creating backup...
✓ Backup created: .env.backups/.env-2024-01-15-143022

Syncing environment variables from 1Password...

Loading mappings via parquet MCP server...
- Resolving OPENAI_API_KEY (using development key)...
- Resolving DATABASE_URL...
- Resolving API_SECRET...

Preserving 2 unmanaged variable(s):
  - LOCAL_DEBUG
  - CUSTOM_SETTING

✓ Replaced 3 managed variable(s) in .env (values NOT shown):
  - API_SECRET
  - DATABASE_URL
  - OPENAI_API_KEY

✓ Sync completed successfully!
```

**Verify .env file:**
- Check that `.env` file exists and has been updated
- Verify managed variables are present
- Verify unmanaged variables are preserved
- Check backup was created in `.env.backups/`

## Configuration

### Exclusion Lists

**Default exclusions** (in `foundation-config.yaml`):
```yaml
tooling:
  env_management:
    onepassword_sync:
      default_exclusions:
        - LOCAL_OVERRIDE
        - TEMP_VAR
```

**Instance-specific exclusions** (in `foundation-config.local.yaml` - gitignored):
```yaml
tooling:
  env_management:
    onepassword_sync:
      exclusions:
        - MY_LOCAL_VAR
        - DEV_ONLY_VAR
```

### Environment-Based Keys

**For environment-specific variables** (e.g., `OPENAI_API_KEY`):
- Set `ENVIRONMENT` environment variable before running:
  ```bash
  export ENVIRONMENT=development  # or production
  python3 "$SCRIPT_PATH"
  ```
- Script will use the appropriate key based on current environment

### MCP Server Configuration

**Parquet MCP server location:**
- Script auto-detects from common locations
- Can override with `PARQUET_MCP_SERVER_PATH` environment variable
- Can override Python command with `PARQUET_MCP_PYTHON` environment variable

## Behavior

**Backup Creation:**
- Creates timestamped backup in `.env.backups/` before modification
- Backup format: `.env-YYYY-MM-DD-HHMMSS`
- Only creates backup if `.env` file exists

**Variable Management:**
- **Managed variables**: Replaced with values from 1Password
- **Unmanaged variables**: Preserved from original `.env` file
- **Excluded variables**: Removed (not preserved)
- **Placeholder variables**: Skipped (preserved if exists, not added if missing)

**File Structure:**
- Preserves comments and headers from original file
- Adds section headers for managed vs unmanaged variables
- Sorts variables alphabetically within each section

**Security:**
- Script NEVER prints secret values
- Only prints variable names that were updated
- Error messages never include CLI output that might contain secrets
- Backups stored in `.env.backups/` (gitignored via `.env.*` pattern)

## Error Handling

### 1Password CLI Not Authenticated

**Error:**
```
ERROR: 1Password CLI is not authenticated.
Please sign in to 1Password:
  eval $(op signin)
```

**Solution:**
- Run `op signin` or `eval $(op signin)`
- Verify with `op whoami`
- Ensure 1Password CLI is installed

### Repository Root Not Found

**Error:**
```
ERROR: Could not find repository root. Ensure foundation-config.yaml or .git exists in the repository.
```

**Solution:**
- Ensure you're in a git repository or directory with `foundation-config.yaml`
- Run script from repository root
- Verify foundation is properly installed

### MCP Server Unavailable

**Warning:**
```
WARNING: MCP server unavailable (...), falling back to direct parquet read
```

**Solution:**
- This is expected if MCP dependencies aren't available
- Script will fall back to direct parquet read
- Ensure `data/env_var_mappings/env_var_mappings.parquet` exists
- Or install MCP dependencies: `pip install mcp`

### Parquet File Not Found

**Error:**
```
ERROR: Environment variable mappings file not found: data/env_var_mappings/env_var_mappings.parquet
```

**Solution:**
- Create the mappings file using MCP parquet server
- Or ensure the file exists at the expected location
- Update mappings via MCP server (add_record/update_record)

### 1Password Reference Resolution Failed

**Warning:**
```
WARNING: Failed to resolve OPENAI_API_KEY: 1Password CLI error for op://...
```

**Solution:**
- Verify the op:// reference is correct
- Ensure you have access to the vault/item/field in 1Password
- Check that the item exists: `op item get "<item-name>" --format=json`
- Update the mapping if the reference is incorrect

### Python Dependencies Missing

**Error:**
```
ModuleNotFoundError: No module named 'pandas'
```

**Solution:**
- Install required packages: `pip install pandas pyarrow`
- For MCP support: `pip install mcp`
- Use virtual environment if needed

## Related Documents

- `scripts/op_sync_env_from_1password.py` - Wrapper script (delegates to foundation)
- `foundation/scripts/op_sync_env_from_1password.py` - Foundation script (generalized implementation)
- `foundation/scripts/README.md` - Complete documentation for the 1Password sync script
- `foundation-config.yaml` - Default exclusions configuration
- `foundation-config.local.yaml` - Instance-specific exclusions (gitignored)
- `data/env_var_mappings/env_var_mappings.parquet` - Environment variable mappings (accessed via MCP)

## Notes

- **Security**: This script should be run locally, not in CI/CD pipelines
- **Never commit `.env` files** to git (should be in `.gitignore`)
- **Backups are gitignored** via `.env.*` pattern
- **Placeholder variables** (with `PLACEHOLDER_` prefix) are skipped until configured
- **Environment-based keys** require `ENVIRONMENT` variable to be set
- **MCP integration** is the primary method; direct parquet read is fallback
- Script preserves unmanaged variables to avoid losing local customizations
- Exclusions allow instance-specific variables to be removed during sync
