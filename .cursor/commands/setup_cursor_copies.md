<!--
⚠️  DO NOT EDIT THIS FILE DIRECTLY

This is a copy of: foundation/agent_instructions/cursor_commands/setup_cursor_copies.md
Source of truth: foundation/agent_instructions/cursor_commands/setup_cursor_copies.md

To edit this command:
1. Edit the source file in foundation: foundation/agent_instructions/cursor_commands/setup_cursor_copies.md
2. Run '/setup_cursor_copies' to sync changes

This file will be overwritten when running setup_cursor_copies.
-->

# Setup Foundation Cursor Copies

Copies foundation cursor rules and commands to `.cursor/` directory (creates independent copies instead of symlinks).

## Command

```
setup_cursor_copies
```

or

```
setup cursor copies
```

## Purpose

This command runs the foundation copy script (`foundation/scripts/setup_cursor_copies.sh`) which:

1. Copies files from `foundation/agent_instructions/cursor_rules/` to `.cursor/rules/`
2. Copies files from `foundation/agent_instructions/cursor_commands/` to `.cursor/commands/`
3. Uses original filenames (no prefix)
4. Removes existing foundation files before creating new copies
5. Preserves any non-foundation files (custom rules/commands)
6. Creates independent copies (not symlinks) - files are standalone

**When run from the foundation repository itself**, it also automatically runs the copy script in peer repositories (located at `../*`) that include this foundation repo via symlink.

## When to Use

- When you want independent copies of foundation rules/commands (not symlinks)
- When you need to customize foundation rules/commands for your repository
- When symlinks are not suitable (e.g., certain deployment scenarios)
- After updating foundation and wanting to refresh your copies
- When you want to version control your own copies of foundation rules

## Differences from Symlink Version

**Symlink version (`setup_symlinks`):**
- Creates symlinks to foundation (single source of truth)
- Updates automatically when foundation changes
- Cannot be customized without breaking the link

**Copy version (`setup_cursor_copies`):**
- Creates independent file copies
- Uses original filenames (no prefix)
- Does NOT update automatically when foundation changes
- Can be customized per repository
- Must re-run script to get foundation updates

## Execution Instructions

### Step 1: Verify Foundation Directory

**Check if foundation exists:**

- Look for `foundation/` directory in repo root
- If not found, check `../foundation/` (parent directory)
- If still not found, error: "Foundation directory not found. Please ensure foundation is installed."

### Step 2: Run Copy Script in Current Repository

**Execute the script:**

```bash
./foundation/scripts/setup_cursor_copies.sh
```

**Or if foundation is in parent directory:**

```bash
../foundation/scripts/setup_cursor_copies.sh
```

### Step 3: Run Copy Script in Peer Repositories (If in Foundation Repo)

**If running from the foundation repository itself** (detected by presence of `agent_instructions/cursor_commands/` directory):

1. **Get current repository absolute path:**
   ```bash
   CURRENT_REPO=$(pwd -P)
   ```

2. **Find peer repositories in parent directory:**
   ```bash
   PARENT_DIR=$(dirname "$CURRENT_REPO")
   for peer_repo in "$PARENT_DIR"/*; do
     # Skip if not a directory or if it's the current repo
     if [ ! -d "$peer_repo" ] || [ "$peer_repo" = "$CURRENT_REPO" ]; then
       continue
     fi
     
     # Check if peer repo has foundation/ symlink pointing to this repo
     if [ -L "$peer_repo/foundation" ]; then
       SYMLINK_TARGET=$(readlink -f "$peer_repo/foundation" 2>/dev/null || readlink "$peer_repo/foundation")
       if [ "$SYMLINK_TARGET" = "$CURRENT_REPO" ]; then
         echo "Found peer repo with foundation symlink: $(basename "$peer_repo")"
         # Run copy script in peer repo using absolute path
         (cd "$peer_repo" && "$CURRENT_REPO/scripts/setup_cursor_copies.sh" || echo "Failed to run in $(basename "$peer_repo")")
       fi
     fi
   done
   ```

**Behavior:**
- Only runs in peer repos if executing from foundation repo itself
- Detects peer repos by checking `../*` directories
- Verifies each peer repo has `foundation/` symlink pointing to current repo
- Runs copy script in each matching peer repo
- Continues even if one peer repo fails

**Expected output (when peer repos found):**
```
[INFO] Setting up cursor rules and commands (copy mode)...
...
[INFO] ✅ Cursor rules setup complete!

[INFO] Detected foundation repository - checking for peer repos...
[INFO] Found peer repo with foundation symlink: my-project
[INFO] Running copy setup script in my-project...
[INFO] Setting up cursor rules and commands (copy mode)...
...
[INFO] ✅ Cursor rules setup complete!
[INFO] ✓ Successfully updated my-project

[INFO] Updated 1 peer repo(s)
```

### Step 4: Verify Results

**Check output:**

- Script should report number of rules copied
- Script should report number of commands copied
- Check `.cursor/rules/` for foundation rule files (not symlinks, using original filenames)
- Check `.cursor/commands/` for foundation command files (not symlinks, using original filenames)

**Expected output:**

```
[INFO] Setting up cursor rules and commands (copy mode)...
[INFO] Foundation directory: foundation
[INFO] Copying generic cursor rules...
  ✓ Copied security.mdc
  ✓ Copied worktree_env.mdc
  ...
[INFO] Copying generic cursor commands...
  ✓ Copied commit.md
  ✓ Copied analyze.md
  ...
[INFO] ✅ Cursor rules setup complete!
[INFO]   Rules copied: X
[INFO]   Commands copied: Y
```

## What Gets Created

**Copied files in `.cursor/rules/`:**
- `security.mdc` (independent copy of `foundation/agent_instructions/cursor_rules/security.mdc`)
- `worktree_env.mdc` (independent copy)
- `readme_maintenance.mdc` (independent copy)
- ... (all rules from foundation, as independent copies, using original filenames)

**Copied files in `.cursor/commands/`:**
- `commit.md` (independent copy of `foundation/agent_instructions/cursor_commands/commit.md`)
- `analyze.md` (independent copy)
- ... (all commands from foundation, as independent copies, using original filenames)

**Note:** Repository rules from `docs/` directory are copied (not symlinked) since Cursor doesn't recognize symlinks. Source files in `docs/` remain the source of truth.

## Behavior

**Filenames:**
- Copied files use original filenames from foundation (no prefix)
- Example: `security.mdc` remains `security.mdc`

**Existing Files:**
- If a file already exists (not a symlink), it's preserved
- Script skips copying to preserve customizations
- To replace with foundation version, manually remove the file first

**Existing Foundation Files:**
- All existing foundation files (old prefixed and new unprefixed) are removed first
- New copies are created fresh with original filenames
- Ensures copies match current foundation version

**Independence:**
- Copied files are independent - changes to foundation do NOT affect them
- You can customize copied files without affecting foundation
- To get foundation updates, re-run this script

## Error Handling

### Foundation Directory Not Found

**Error:**
```
[ERROR] Foundation directory not found. Please run from repository root or ensure foundation is installed.
```

**Solution:**
- Ensure you're in repository root
- Verify foundation is installed (as submodule or symlink)
- Check if foundation is in parent directory

### Cursor Rules Directory Not Found

**Error:**
```
[ERROR] Cursor rules directory not found: foundation/agent_instructions/cursor_rules
```

**Solution:**
- Verify foundation submodule is initialized: `git submodule update --init`
- Check that foundation has cursor rules directory

### Cursor Commands Directory Not Found

**Error:**
```
[ERROR] Cursor commands directory not found: foundation/agent_instructions/cursor_commands
```

**Solution:**
- Verify foundation submodule is initialized: `git submodule update --init`
- Check that foundation has cursor commands directory

## Related Documents

- `foundation/scripts/setup_cursor_copies.sh` - The script that performs the copying
- `foundation/scripts/setup_cursor_rules.sh` - The symlink version (alternative)
- `foundation/agent_instructions/README.md` - Cursor rules and commands documentation
- `foundation/README.md` - Foundation overview and installation

## Notes

- **Independent copies**: Files are standalone, not linked to foundation
- **Original filenames**: Uses original filenames from foundation (no prefix)
- **No automatic updates**: Changes to foundation do NOT affect copied files
- **Customization allowed**: You can modify copied files for your repository
- **Version control**: Copied files can be committed to your repository
- **Refresh required**: Re-run this script to get foundation updates
- **Repository rules**: Rules from `docs/` directory are copied (not symlinked, since Cursor doesn't recognize symlinks)
- **Repository rule updates**: Existing copies are updated if source files in `docs/` are newer
- **When run from foundation repo**: Automatically propagates to peer repos that symlink to this foundation
- **Peer repo detection**: Only processes repos in `../*` that have `foundation/` symlink pointing to this repo

## Choosing Between Symlinks and Copies

**Use symlinks (`setup_symlinks`) when:**
- You want automatic updates when foundation changes
- You want a single source of truth
- You don't need to customize foundation rules
- You're using foundation as a submodule

**Use copies (`setup_cursor_copies`) when:**
- You need to customize foundation rules for your repository
- You want to version control your own copies
- Symlinks are not suitable for your deployment
- You want independent files that won't change when foundation updates
